<!DOCTYPE html>
<html encoding="UTF-8" charset="UTF-8" dir="ltr" lang="en-US" xml:lang="en-US" language="English" itemscope="" itemtype="http://schema.org/WebPage" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">

<head>
<!-- ╔════════════════════════════════════════════════╗
     ║ favor latest IE with Chrome-Frame if possible. ║
     ╚════════════════════════════════════════════════╝ -->
  <meta http-equiv="X-UA-Compatible"                   content="IE=edge,chrome=1"                                      />
<!-- ╔════════════════════════════════════════════════════════════╗
     ║ normalize script/style engine with explicit character-set. ║
     ╚════════════════════════════════════════════════════════════╝ -->
  <meta charset="UTF-8"                                                                                                />
  <meta http-equiv="content-type"                      content="text/html;charset=UTF-8"                               />
  <meta http-equiv="Content-Script-Type"               content="text/javascript;charset=UTF-8"                         />
  <meta http-equiv="Content-Style-Type"                content="text/css;charset=UTF-8"                                />
<!-- ╔══════════════════════════════════════════════╗
     ║ bread and butter of mobile-friendly website. ║
     ╚══════════════════════════════════════════════╝ -->
  <meta name="viewport"                                content="width=device-width,initial-scale=1.0,shrink-to-fit=no,minimal-ui"                                           />
<!-- ╔════════════════════════════╗
     ║ poor's man's HTTP-Headers. ║
     ╚════════════════════════════╝ -->
  <meta http-equiv="Feature-Policy"                    content="fullscreen *; wake-lock *; vibrate *; geolocation *;"  />
  <meta http-equiv="Cache-Control"                     content="public,max-age=1800,max-stale,stale-while-revalidate=86400,stale-if-error=259200" rem="max-age=30minutes"   />
  <meta http-equiv="X-Content-Type-Options"            content="nosniff"                                               />
  <meta http-equiv="X-DNS-Prefetch-Control"            content="on"                                                    />
<!-- needs more work... 
  <meta http-equiv="Content-Security-Policy"           content="default-src 'none'; base-uri 'self'; block-all-mixed-content; connect-src 'self' icompile.eladkarako.com eladkarako.com eladkarako.github.io www.google.com www.google-analytics.com www.googletagmanager.com www.github.com gist.github.com gist.githubusercontent.com; font-src github.githubassets.com; form-action 'none; frame-ancestors 'self'; frame-src 'self' render.githubusercontent.com gist.github.com; img-src 'self' *.imgur.com data: *.githubusercontent.com; media-src 'none'; script-src 'self' github.githubassets.com; style-src 'unsafe-inline' github.githubassets.com; worker-src 'none'"                                                                                                         />
-->  
  <meta http-equiv="X-XSS-Protection"                  content="1; mode=block"                                         />
<!-- ╔════════════════════════════════════╗
     ║ disable browser annoying features. ║
     ╚════════════════════════════════════╝ -->
  <meta name="format-detection"                        content="telephone=no,date=no,address=no,email=no,url=no"       />
  <meta http-equiv="imagetoolbar"                      content="no"                                                    />
  <meta http-equiv="cleartype"                         content="on"                                                    />
  <meta http-equiv="Page-Enter"                        content="RevealTrans(Duration=0.0,Transition=0.0)"              />
  <meta http-equiv="Page-Exit"                         content="RevealTrans(Duration=0.0,Transition=0.0)"              />
  <!-----------------------------------------------------------------------do not modify line below here, an installed skype read it AS IS (you need to make the HTML is UTF-8 (no BOM) with Windown EOL). -->
  <meta name="SKYPE_TOOLBAR" content="SKYPE_TOOLBAR_PARSER_COMPATIBLE">
  <!--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------->
<!-- ╔══════════════════════════════════╗
     ║ compatible with viewport for IE. ║
     ╚══════════════════════════════════╝ -->
  <meta name="HandheldFriendly"                        content="True"              />
  <meta name="MSThemeCompatible"                       content="no"                />
  <meta name="theme-color"                             content="#b1cff4"           />
  <meta name="mssmarttagspreventparsing"               content="true"              />
  <meta name="apple-mobile-web-app-capable"            content="yes"               />
  <meta name="apple-mobile-web-app-status-bar-style"   content="translucent black" />
  <meta name="msapplication-navbutton-color"           content="translucent black" />
<!-- ╔══════════╗
     ║ audience ║
     ╚══════════╝ -->
  <meta name="target"                                  content="all"               />
  <meta name="audience"                                content="all"               />
  <meta name="coverage"                                content="Worldwide"         />
  <meta name="distribution"                            content="Global"            />
  <meta name="rating"                                  content="safe for kids"     />
<!-- ╔══════════╗
     ║ language ║
     ╚══════════╝ -->
  <meta http-equiv="Content-Language"                  content="en-US"             />
  <meta property="og:locale"                           content="en_US"             />
  <meta name="language"                                content="English"           />
  <meta name="og:type"                                 content="article"           />
<!-- ╔═══════════════════════════════╗
     ║ site-name and author contact. ║
     ╚═══════════════════════════════╝ -->
  <meta property="og:site_name"                        content="iCompile"          />
  <meta name="article:author"                          content="Elad Karako"       />
  <meta name="author"                                  content="Elad Karako"       />
  <meta name="owner"                                   content="Elad Karako"       />
  <meta name="contactName"                             content="Elad Karako"       />
  <meta name="dcterms.creator"                         content="Elad Karako"       />
  <link rel="me"                                       href="https://github.com/eladkarako/"  type="text/html"  />
  <link rel="author"                                   href="https://github.com/eladkarako/"                    />
  <link rel="profile"                                  href="https://gmpg.org/xfn/11"                           />
  <meta name="dcterms.type"                            content="Text"              />
  <meta name="dcterms.format"                          content="text/html"         />  
<!-- ╔═════════════════════════════════════╗
     ║ specific page information - title . ║
     ╚═════════════════════════════════════╝ -->
  <title>varnish-cache + WAMP + NodeJS + Socket.IO</title>
  <meta itemprop="name"                                content="varnish-cache + WAMP + NodeJS + Socket.IO"       />
  <meta name="dcterms.title"                           content="varnish-cache + WAMP + NodeJS + Socket.IO"       />
  <meta property="og:title"                            content="varnish-cache + WAMP + NodeJS + Socket.IO"       />
  <meta name="twitter:title"                           content="varnish-cache + WAMP + NodeJS + Socket.IO"       />
  <meta name="twitter:text:title"                      content="varnish-cache + WAMP + NodeJS + Socket.IO"       />
  <meta name="application-name"                        content="varnish-cache + WAMP + NodeJS + Socket.IO"       />
  <meta name="subject"                                 content="varnish-cache + WAMP + NodeJS + Socket.IO"       />
  <meta name="apple-mobile-web-app-title"              content="varnish-cache + WAMP + NodeJS + Socket.IO"       />
  <meta name="msapplication-tooltip"                   content="varnish-cache + WAMP + NodeJS + Socket.IO"       />
<!-- ╔══════════════════════════════════════════════════════════════╗
     ║ specific page information - description (title is fine too). ║
     ╚══════════════════════════════════════════════════════════════╝ -->
  <meta name="description"                             content="varnish-cache + WAMP + NodeJS + Socket.IO"       />
  <meta itemprop="description"                         content="varnish-cache + WAMP + NodeJS + Socket.IO"       />
  <meta name="dcterms.description"                     content="varnish-cache + WAMP + NodeJS + Socket.IO"       />
  <meta name="twitter:description"                     content="varnish-cache + WAMP + NodeJS + Socket.IO"       />
  <meta property="og:description"                      content="varnish-cache + WAMP + NodeJS + Socket.IO"       />
<!-- ╔═══════════╗
     ║ keywords. ║
     ╚═══════════╝ -->
  <meta property="keywords"                            content="abacus,abruptly,abuot,accept,acceptable,accepted,access,accessible,account,achieve,achieved,action,actions,active,activity,adapter,adapters,adaptor,adaptors,adding,addons,addtionally,addy,addyosmani,admin,adminnode,advantage,advantages,advocating,afflicting,ahead,ajax,alias,aliases,alleviate,allocated,allocating,allocation,allocations,allowed,allowing,amazing,amazon,amazonaws,amount,amounts,analyse,analytics,android,animations,answer,anti,apache,apparent,appears,appfog,application,apply,approach,apps,architect,archived,areas,argteam,argument,arguments,arrangement,article,articles,aspects,assertions,asset,assets,assume,assumes,assuming,async,attitude,attractive,attributes,author,automate,avatar,average,averaging,avoid,aware,awesome,back,backed,backend,backlog,balancer,balancing,bandwidth,barely,base,based,basic,basically,basket,battery,battling,beefy,begins,behave,behaving,behavior,behaviour,benchmarks,benefit,benefits,beta,beware,bigger,billions,bind,binding,black,blank,blazing,bloat,blocking,blog,blue,bold,bookmark,boolean,boost,boot,booting,born,bother,bothered,bottleneck,bottlenecks,brand,break,breaking,broken,brought,browse,browser,browsers,browsing,bucket,buckets,budget,bugger,build,building,builds,built,bundle,bundled,burning,busy,button,buttons,cache,cached,caching,call,callback,callbacks,called,calls,calomel,campfire,campfirenow,candidates,caolan,capable,capacity,capistrano,capturing,card,career,carries,carry,cases,catch,catching,category,caught,caused,cdns,cement,chain,challenge,challenges,change,changed,channel,channels,chat,chatbot,chats,chatting,cheaper,check,checked,checking,checks,chef,choice,choose,clarity,classes,classic,clean,cleaner,cleanup,cleared,clearer,clever,click,clicked,clicking,client,clients,cloning,close,closed,closely,cloud,cloudfront,clumsy,clunky,cluster,clustering,code,coded,codeutopia,coding,collection,color,colour,combination,combing,coming,command,commands,comment,comments,committing,commodity,common,commonly,communicate,compact,company,compatible,competing,complaining,complements,complete,completed,completely,completion,complex,component,components,compress,compression,comprises,compromise,computing,concept,concepts,concern,concerns,concise,conclusions,concurrent,conditional,conf,confident,config,configs,configure,configuring,conjunction,connect,connected,connecting,connection,connections,cons,consistent,console,constant,constants,consuming,contact,content,contents,context,contextual,contianing,continually,continue,control,controller,convenience,convenient,convention,conventions,converting,convey,cook,cookbook,cookies,core,cores,cost,costs,counters,couple,cover,crash,crashes,crashing,create,created,creation,creative,credit,crit,criticism,cron,cronjobs,crontabs,crosses,custom,customer,cutting,cycle,dangerous,dashboard,dashboards,data,database,databases,date,days,ddollar,dead,deal,dealing,debian,debug,decide,decided,decision,decisions,decrease,decreases,dedicated,deep,default,defaults,define,defined,definitions,delays,delete,deliver,delivered,delivery,denodify,denote,depend,dependant,dependency,depending,deploy,deployed,deploying,deployment,deployments,deploys,describe,describes,description,design,designed,designing,desk,desktop,detached,details,detect,devcenter,develop,developed,developer,developers,developing,development,devices,dictated,difference,differences,difficult,digest,digging,direct,directive,directives,directly,dirname,disabled,discerned,disconnects,disk,display,distinct,distributed,ditch,divide,docker,docs,document,dollars,domain,domains,doom,dosomething,downgrade,download,downloading,downtime,drag,drive,driven,drop,dropped,dump,duplicate,duplicating,durable,duty,dynamic,dynamically,earlier,early,easier,easiest,easily,easy,ebay,ecommerce,edge,edited,effectively,effects,efficiency,efficient,efficiently,elapse,elastic,elbow,eliminating,email,emails,emit,emitter,employ,employing,encapsulate,encounters,encouraged,encourages,endows,ends,engineer,engineering,ensure,ensuring,enter,entry,enumerable,environment,equivalent,error,errors,essays,essential,essentials,estab,established,etsy,evenly,events,examples,excellent,exception,exceptions,execute,executes,executing,execution,exhaustive,exist,existed,existing,exit,exits,expand,expect,expected,experience,experiment,explodes,exploring,export,exported,exports,exposes,expressjs,extend,extensive,extensively,external,extra,extract,face,facebook,faced,facility,fail,failed,failing,fails,failure,falls,falsy,fancy,fans,fascinating,fast,faster,fault,faulty,favatar,favour,favourite,favourites,fcall,feasibly,features,featureset,feedback,feel,feels,felt,fetched,fetching,fewer,fight,figure,figures,file,files,filter,find,fine,finer,finger,finishes,fire,firefight,fixed,fixtures,flat,flexibility,flexible,flint,flooding,flow,fluctuates,flush,flux,focus,focusing,folder,font,footer,foreach,foreman,forget,forgetful,forks,form,format,forms,formulated,forwarded,found,foundations,frag,frames,framework,frameworks,free,friday,friendly,frontend,frustrating,fsecure,function,functions,fused,futile,future,ganglia,garrett,geared,generate,generated,generates,generation,generators,generic,geographic,gerhard,getdetails,getsitelist,getter,getuser,giantcomet,gist,github,gitignore,glob,globally,globals,goal,good,goodbye,google,gosquared,gracefully,gradients,grained,graphite,grateful,gravatar,grease,great,greatly,grey,group,groups,growing,guarantee,guaranteed,guide,guidelines,hack,hacker,hacking,halt,handing,handle,handled,handler,handlers,handles,handling,handy,hanging,happen,happening,haproxy,hardening,hardware,hash,header,headers,health,heavy,hell,helped,helper,helpers,helpful,helping,helps,hentry,hero,heroku,hgroup,high,highlight,higlighting,hiring,history,hits,hitting,home,hopped,host,hosted,hosting,hostnames,hosts,hours,html,httponly,hubot,huge,hundreds,idea,identifier,idle,idling,images,impact,implement,implies,import,importance,imposes,imprecise,improve,improvement,improving,inactive,include,included,includes,increase,increased,increases,increasing,incredibly,indentation,index,individual,inefficient,inet,infancy,infinite,info,inform,information,informative,informing,inherit,inheriting,inherits,initial,initrc,inline,insert,insight,inspired,install,installing,integrate,integration,intelligent,intended,interact,interacting,interested,interesting,interface,internal,internet,introduced,introduces,introducing,investigate,invoke,involves,iphone,irrelevant,isdown,isolated,issue,issues,isup,italic,items,iterate,javascript,jekyll,jenkins,jobs,journey,jpeg,jquery,json,kbytes,keen,keepalive,kepy,kernel,keys,keyword,kind,knew,kriskowal,laborious,labs,lack,lacked,language,languages,larger,latency,laterally,latest,launched,layout,layouts,lead,lean,learn,learning,leave,leeway,lends,level,levels,libraries,library,lifecycle,lightweight,limit,limitations,limited,limiting,limits,line,lines,linkedin,links,linux,liquid,liquidicity,list,listed,listen,listener,listeners,lived,loaded,loader,loads,local,locally,location,locations,locking,logged,logging,logic,logical,logins,logo,logs,longer,looked,loop,lose,loses,lost,lots,love,loves,lowering,luckily,lying,machine,made,mailing,maintain,maintaining,maintenance,majority,make,makes,making,manage,manageable,managed,management,manager,managing,manual,manually,mapped,march,marketing,massive,matching,matures,maximum,maxing,meaning,meant,mechanised,mechanism,melted,memory,mentioned,menubar,mercy,merged,message,messages,messy,meta,method,methodology,methods,meticulous,metrics,middleware,middlewares,mighty,migrated,migration,millions,minefield,minify,minimally,minimise,minimum,misbehave,misspell,mistake,mistyped,mmonit,mobile,mocha,mode,modify,modularised,modularity,module,modules,momentjs,mongodb,monit,monitoring,month,months,morning,motivation,move,moving,mozilla,mugshot,multi,multiple,mysql,names,namespace,namespaces,native,naturally,nature,navigation,nbsp,nckuzy,nearest,neatly,necessarily,needed,needing,negligible,nested,nesting,netdev,netstat,network,networking,newrelic,news,nginx,nicest,node,nodejitsu,nodejs,nodester,nodetime,noise,nope,note,notice,noticeable,noticed,november,npmjs,null,number,numbers,object,obscure,obsolete,occupied,occur,occurred,occurs,offer,offers,official,offs,older,oops,open,openshift,operation,operational,operations,operator,opportunity,opscode,optimise,optimised,optimises,optimising,option,optionally,options,originally,originated,orphaned,osmani,ounce,output,outweights,overboard,overhead,override,paas,pack,package,page,pagerduty,pages,papers,paradigms,parallel,parallelism,parallelize,param,parameter,parameters,partially,partnership,parts,party,pass,passed,passing,password,past,path,pattern,patterns,paying,pedantic,penalty,pending,perfect,perfectly,perform,performance,person,phones,photo,pick,pierced,pipeline,pitfalls,places,plan,planned,plans,platform,play,plenty,plotting,plugin,pointers,pointing,pointless,pooling,popstate,popular,port,portion,portions,ports,post,posted,posting,posts,potentially,power,powerful,powers,practise,precious,precisely,prefer,premature,premise,prestiged,pretend,pretty,prevent,preview,price,pricing,principles,print,priority,private,probes,problem,procedure,procedures,process,processed,processes,processing,production,program,progress,project,promise,promises,prone,properly,properties,property,pros,protection,proto,protocol,protocols,prototype,proved,provide,providers,providing,proxies,proxy,public,publicly,publish,pull,pumping,punctuation,pure,push,pushed,pushes,pushstate,putting,pyramid,quality,queries,query,querying,question,questions,queue,queueing,quicker,quirks,quot,quote,rabbitmq,raised,random,range,rapidly,rare,rarely,ratio,react,read,readable,readdirsync,reading,readme,reads,ready,realise,realised,rearranging,reasoning,reasons,rebooted,receives,receiving,recently,recommended,record,records,recovery,recycle,recycled,redis,reduce,reduced,reducing,reduction,redundancy,reference,references,referencing,reflect,refuse,regenerate,regressions,regular,reinvented,release,released,reload,reloading,remained,remove,removing,render,rendering,repertoire,replace,replaced,replacement,reply,repo,repository,represent,represents,request,requested,requesting,requests,require,required,requires,rescue,research,reserved,resource,resources,respawning,respectable,respond,response,responsive,restart,restarting,restrict,resultant,resulting,results,retained,retaliation,retries,retrieve,return,reuse,reverse,reward,rewrite,rewriting,ribbon,ridiculous,rigourous,ringtone,risk,rjlqax,rked,rmem,robining,robust,rock,room,roughly,round,route,routes,routing,rubbish,ruby,rule,running,runtime,russ,saas,safe,safely,salvage,saturate,saturated,save,saves,scalability,scale,scales,scaling,schedule,scheduler,scope,scratch,screens,scribble,script,scripted,scripts,scrolling,seamlessly,secondary,seconds,section,secure,security,seek,select,selector,senchalabs,send,sending,sense,sensu,separate,separation,sequential,serenity,series,serve,served,server,servers,serves,service,services,serving,session,sessions,sets,setting,settings,setup,severity,shadows,share,shared,sharing,shell,shipping,shoot,shop,shortest,shortlist,shot,sick,sign,signal,signals,signing,signup,signups,silence,silly,simon,simontabor,simple,simply,singapore,single,sink,site,sites,sitting,situation,size,skillset,skip,skool,skype,slack,slect,sleep,slice,slight,slipped,slow,slowing,sluggish,small,smaller,snappier,socket,sockets,solely,solid,solution,solve,somaxconn,sonian,sort,sounds,source,sourceforge,space,spare,spawn,spawned,spawning,special,specially,specific,sped,speed,speedguide,spellcheck,spend,spent,spheromak,spinner,split,spoken,spot,spots,sprawled,spread,squeeze,stability,stable,stack,stage,stages,staging,standard,stanza,start,started,starting,starts,startups,state,statements,states,static,staticsite,statsd,status,stay,step,steps,stick,stop,stopping,storage,storing,story,straight,strategy,stray,streamline,strengths,strong,structure,stuck,studies,stuff,subject,subscribing,substr,subtitle,succeeded,success,succinctly,suggests,suited,super,superficial,supervisor,support,supporting,supposed,suspend,suspends,sustainable,switch,switched,switching,syctl,symptom,synack,synrecv,sysctl,syslog,system,systems,table,tabor,tags,tailor,takes,target,task,tasks,team,technical,techniques,templates,tempted,tend,tens,term,terminal,terminology,terribly,test,testing,tests,thinking,thought,thoughts,thousands,thread,threaded,threads,thresholds,throttled,throughput,throw,thrown,tidy,timeframe,timeout,timeouts,times,timewait,timezone,tiny,tinyspeck,tips,title,today,told,tolerance,tool,tooling,tools,total,touch,touched,touchend,touchstart,traces,track,trackable,tracked,trade,traffic,train,trains,transience,transition,transport,trend,trends,trickier,tricky,trigger,triggered,triggers,trivial,trusty,ttls,tuned,tuning,turn,turned,tweaked,tweaking,tweaks,twitter,tying,type,ubuntu,unavailable,unavoidable,uncaught,unchanged,uncovered,underlying,understand,unexpected,unfeasible,uniq,unit,unnecessary,unrelated,unstable,update,updated,updates,upgrade,upstart,upstream,uptime,upwards,usable,usage,user,userland,users,util,utilisation,utilise,utilities,validation,valuable,variable,variety,varnish,vary,vast,vastly,vcard,vehemently,verify,versatile,version,versioning,viability,viable,viewed,viewform,viewport,virtually,visionmedia,visual,visualise,vital,voice,volume,volumes,vows,vowsjs,wait,waiting,wamp,wanted,warning,wastage,ways,weak,weaknesses,wealth,weaved,website,week,weeks,weight,whilst,white,widget,widgets,wiki,wikidot,wikipedia,wise,wmem,woefully,wonders,work,worked,worker,working,workload,workloads,works,worry,worse,worth,wrapper,write,writeup,writing,written,wrong,wrote,yaml,yeah,years,yesterday,yield,ymmv,zone,eladkarako,eladkarakomod,icompile,Elad Karako,Karako Elad,אלעד קרקו,קרקו אלעד,קרקו"    />
  <meta property="article:tag"                         content="abacus,abruptly,abuot,accept,acceptable,accepted,access,accessible,account,achieve,achieved,action,actions,active,activity,adapter,adapters,adaptor,adaptors,adding,addons,addtionally,addy,addyosmani,admin,adminnode,advantage,advantages,advocating,afflicting,ahead,ajax,alias,aliases,alleviate,allocated,allocating,allocation,allocations,allowed,allowing,amazing,amazon,amazonaws,amount,amounts,analyse,analytics,android,animations,answer,anti,apache,apparent,appears,appfog,application,apply,approach,apps,architect,archived,areas,argteam,argument,arguments,arrangement,article,articles,aspects,assertions,asset,assets,assume,assumes,assuming,async,attitude,attractive,attributes,author,automate,avatar,average,averaging,avoid,aware,awesome,back,backed,backend,backlog,balancer,balancing,bandwidth,barely,base,based,basic,basically,basket,battery,battling,beefy,begins,behave,behaving,behavior,behaviour,benchmarks,benefit,benefits,beta,beware,bigger,billions,bind,binding,black,blank,blazing,bloat,blocking,blog,blue,bold,bookmark,boolean,boost,boot,booting,born,bother,bothered,bottleneck,bottlenecks,brand,break,breaking,broken,brought,browse,browser,browsers,browsing,bucket,buckets,budget,bugger,build,building,builds,built,bundle,bundled,burning,busy,button,buttons,cache,cached,caching,call,callback,callbacks,called,calls,calomel,campfire,campfirenow,candidates,caolan,capable,capacity,capistrano,capturing,card,career,carries,carry,cases,catch,catching,category,caught,caused,cdns,cement,chain,challenge,challenges,change,changed,channel,channels,chat,chatbot,chats,chatting,cheaper,check,checked,checking,checks,chef,choice,choose,clarity,classes,classic,clean,cleaner,cleanup,cleared,clearer,clever,click,clicked,clicking,client,clients,cloning,close,closed,closely,cloud,cloudfront,clumsy,clunky,cluster,clustering,code,coded,codeutopia,coding,collection,color,colour,combination,combing,coming,command,commands,comment,comments,committing,commodity,common,commonly,communicate,compact,company,compatible,competing,complaining,complements,complete,completed,completely,completion,complex,component,components,compress,compression,comprises,compromise,computing,concept,concepts,concern,concerns,concise,conclusions,concurrent,conditional,conf,confident,config,configs,configure,configuring,conjunction,connect,connected,connecting,connection,connections,cons,consistent,console,constant,constants,consuming,contact,content,contents,context,contextual,contianing,continually,continue,control,controller,convenience,convenient,convention,conventions,converting,convey,cook,cookbook,cookies,core,cores,cost,costs,counters,couple,cover,crash,crashes,crashing,create,created,creation,creative,credit,crit,criticism,cron,cronjobs,crontabs,crosses,custom,customer,cutting,cycle,dangerous,dashboard,dashboards,data,database,databases,date,days,ddollar,dead,deal,dealing,debian,debug,decide,decided,decision,decisions,decrease,decreases,dedicated,deep,default,defaults,define,defined,definitions,delays,delete,deliver,delivered,delivery,denodify,denote,depend,dependant,dependency,depending,deploy,deployed,deploying,deployment,deployments,deploys,describe,describes,description,design,designed,designing,desk,desktop,detached,details,detect,devcenter,develop,developed,developer,developers,developing,development,devices,dictated,difference,differences,difficult,digest,digging,direct,directive,directives,directly,dirname,disabled,discerned,disconnects,disk,display,distinct,distributed,ditch,divide,docker,docs,document,dollars,domain,domains,doom,dosomething,downgrade,download,downloading,downtime,drag,drive,driven,drop,dropped,dump,duplicate,duplicating,durable,duty,dynamic,dynamically,earlier,early,easier,easiest,easily,easy,ebay,ecommerce,edge,edited,effectively,effects,efficiency,efficient,efficiently,elapse,elastic,elbow,eliminating,email,emails,emit,emitter,employ,employing,encapsulate,encounters,encouraged,encourages,endows,ends,engineer,engineering,ensure,ensuring,enter,entry,enumerable,environment,equivalent,error,errors,essays,essential,essentials,estab,established,etsy,evenly,events,examples,excellent,exception,exceptions,execute,executes,executing,execution,exhaustive,exist,existed,existing,exit,exits,expand,expect,expected,experience,experiment,explodes,exploring,export,exported,exports,exposes,expressjs,extend,extensive,extensively,external,extra,extract,face,facebook,faced,facility,fail,failed,failing,fails,failure,falls,falsy,fancy,fans,fascinating,fast,faster,fault,faulty,favatar,favour,favourite,favourites,fcall,feasibly,features,featureset,feedback,feel,feels,felt,fetched,fetching,fewer,fight,figure,figures,file,files,filter,find,fine,finer,finger,finishes,fire,firefight,fixed,fixtures,flat,flexibility,flexible,flint,flooding,flow,fluctuates,flush,flux,focus,focusing,folder,font,footer,foreach,foreman,forget,forgetful,forks,form,format,forms,formulated,forwarded,found,foundations,frag,frames,framework,frameworks,free,friday,friendly,frontend,frustrating,fsecure,function,functions,fused,futile,future,ganglia,garrett,geared,generate,generated,generates,generation,generators,generic,geographic,gerhard,getdetails,getsitelist,getter,getuser,giantcomet,gist,github,gitignore,glob,globally,globals,goal,good,goodbye,google,gosquared,gracefully,gradients,grained,graphite,grateful,gravatar,grease,great,greatly,grey,group,groups,growing,guarantee,guaranteed,guide,guidelines,hack,hacker,hacking,halt,handing,handle,handled,handler,handlers,handles,handling,handy,hanging,happen,happening,haproxy,hardening,hardware,hash,header,headers,health,heavy,hell,helped,helper,helpers,helpful,helping,helps,hentry,hero,heroku,hgroup,high,highlight,higlighting,hiring,history,hits,hitting,home,hopped,host,hosted,hosting,hostnames,hosts,hours,html,httponly,hubot,huge,hundreds,idea,identifier,idle,idling,images,impact,implement,implies,import,importance,imposes,imprecise,improve,improvement,improving,inactive,include,included,includes,increase,increased,increases,increasing,incredibly,indentation,index,individual,inefficient,inet,infancy,infinite,info,inform,information,informative,informing,inherit,inheriting,inherits,initial,initrc,inline,insert,insight,inspired,install,installing,integrate,integration,intelligent,intended,interact,interacting,interested,interesting,interface,internal,internet,introduced,introduces,introducing,investigate,invoke,involves,iphone,irrelevant,isdown,isolated,issue,issues,isup,italic,items,iterate,javascript,jekyll,jenkins,jobs,journey,jpeg,jquery,json,kbytes,keen,keepalive,kepy,kernel,keys,keyword,kind,knew,kriskowal,laborious,labs,lack,lacked,language,languages,larger,latency,laterally,latest,launched,layout,layouts,lead,lean,learn,learning,leave,leeway,lends,level,levels,libraries,library,lifecycle,lightweight,limit,limitations,limited,limiting,limits,line,lines,linkedin,links,linux,liquid,liquidicity,list,listed,listen,listener,listeners,lived,loaded,loader,loads,local,locally,location,locations,locking,logged,logging,logic,logical,logins,logo,logs,longer,looked,loop,lose,loses,lost,lots,love,loves,lowering,luckily,lying,machine,made,mailing,maintain,maintaining,maintenance,majority,make,makes,making,manage,manageable,managed,management,manager,managing,manual,manually,mapped,march,marketing,massive,matching,matures,maximum,maxing,meaning,meant,mechanised,mechanism,melted,memory,mentioned,menubar,mercy,merged,message,messages,messy,meta,method,methodology,methods,meticulous,metrics,middleware,middlewares,mighty,migrated,migration,millions,minefield,minify,minimally,minimise,minimum,misbehave,misspell,mistake,mistyped,mmonit,mobile,mocha,mode,modify,modularised,modularity,module,modules,momentjs,mongodb,monit,monitoring,month,months,morning,motivation,move,moving,mozilla,mugshot,multi,multiple,mysql,names,namespace,namespaces,native,naturally,nature,navigation,nbsp,nckuzy,nearest,neatly,necessarily,needed,needing,negligible,nested,nesting,netdev,netstat,network,networking,newrelic,news,nginx,nicest,node,nodejitsu,nodejs,nodester,nodetime,noise,nope,note,notice,noticeable,noticed,november,npmjs,null,number,numbers,object,obscure,obsolete,occupied,occur,occurred,occurs,offer,offers,official,offs,older,oops,open,openshift,operation,operational,operations,operator,opportunity,opscode,optimise,optimised,optimises,optimising,option,optionally,options,originally,originated,orphaned,osmani,ounce,output,outweights,overboard,overhead,override,paas,pack,package,page,pagerduty,pages,papers,paradigms,parallel,parallelism,parallelize,param,parameter,parameters,partially,partnership,parts,party,pass,passed,passing,password,past,path,pattern,patterns,paying,pedantic,penalty,pending,perfect,perfectly,perform,performance,person,phones,photo,pick,pierced,pipeline,pitfalls,places,plan,planned,plans,platform,play,plenty,plotting,plugin,pointers,pointing,pointless,pooling,popstate,popular,port,portion,portions,ports,post,posted,posting,posts,potentially,power,powerful,powers,practise,precious,precisely,prefer,premature,premise,prestiged,pretend,pretty,prevent,preview,price,pricing,principles,print,priority,private,probes,problem,procedure,procedures,process,processed,processes,processing,production,program,progress,project,promise,promises,prone,properly,properties,property,pros,protection,proto,protocol,protocols,prototype,proved,provide,providers,providing,proxies,proxy,public,publicly,publish,pull,pumping,punctuation,pure,push,pushed,pushes,pushstate,putting,pyramid,quality,queries,query,querying,question,questions,queue,queueing,quicker,quirks,quot,quote,rabbitmq,raised,random,range,rapidly,rare,rarely,ratio,react,read,readable,readdirsync,reading,readme,reads,ready,realise,realised,rearranging,reasoning,reasons,rebooted,receives,receiving,recently,recommended,record,records,recovery,recycle,recycled,redis,reduce,reduced,reducing,reduction,redundancy,reference,references,referencing,reflect,refuse,regenerate,regressions,regular,reinvented,release,released,reload,reloading,remained,remove,removing,render,rendering,repertoire,replace,replaced,replacement,reply,repo,repository,represent,represents,request,requested,requesting,requests,require,required,requires,rescue,research,reserved,resource,resources,respawning,respectable,respond,response,responsive,restart,restarting,restrict,resultant,resulting,results,retained,retaliation,retries,retrieve,return,reuse,reverse,reward,rewrite,rewriting,ribbon,ridiculous,rigourous,ringtone,risk,rjlqax,rked,rmem,robining,robust,rock,room,roughly,round,route,routes,routing,rubbish,ruby,rule,running,runtime,russ,saas,safe,safely,salvage,saturate,saturated,save,saves,scalability,scale,scales,scaling,schedule,scheduler,scope,scratch,screens,scribble,script,scripted,scripts,scrolling,seamlessly,secondary,seconds,section,secure,security,seek,select,selector,senchalabs,send,sending,sense,sensu,separate,separation,sequential,serenity,series,serve,served,server,servers,serves,service,services,serving,session,sessions,sets,setting,settings,setup,severity,shadows,share,shared,sharing,shell,shipping,shoot,shop,shortest,shortlist,shot,sick,sign,signal,signals,signing,signup,signups,silence,silly,simon,simontabor,simple,simply,singapore,single,sink,site,sites,sitting,situation,size,skillset,skip,skool,skype,slack,slect,sleep,slice,slight,slipped,slow,slowing,sluggish,small,smaller,snappier,socket,sockets,solely,solid,solution,solve,somaxconn,sonian,sort,sounds,source,sourceforge,space,spare,spawn,spawned,spawning,special,specially,specific,sped,speed,speedguide,spellcheck,spend,spent,spheromak,spinner,split,spoken,spot,spots,sprawled,spread,squeeze,stability,stable,stack,stage,stages,staging,standard,stanza,start,started,starting,starts,startups,state,statements,states,static,staticsite,statsd,status,stay,step,steps,stick,stop,stopping,storage,storing,story,straight,strategy,stray,streamline,strengths,strong,structure,stuck,studies,stuff,subject,subscribing,substr,subtitle,succeeded,success,succinctly,suggests,suited,super,superficial,supervisor,support,supporting,supposed,suspend,suspends,sustainable,switch,switched,switching,syctl,symptom,synack,synrecv,sysctl,syslog,system,systems,table,tabor,tags,tailor,takes,target,task,tasks,team,technical,techniques,templates,tempted,tend,tens,term,terminal,terminology,terribly,test,testing,tests,thinking,thought,thoughts,thousands,thread,threaded,threads,thresholds,throttled,throughput,throw,thrown,tidy,timeframe,timeout,timeouts,times,timewait,timezone,tiny,tinyspeck,tips,title,today,told,tolerance,tool,tooling,tools,total,touch,touched,touchend,touchstart,traces,track,trackable,tracked,trade,traffic,train,trains,transience,transition,transport,trend,trends,trickier,tricky,trigger,triggered,triggers,trivial,trusty,ttls,tuned,tuning,turn,turned,tweaked,tweaking,tweaks,twitter,tying,type,ubuntu,unavailable,unavoidable,uncaught,unchanged,uncovered,underlying,understand,unexpected,unfeasible,uniq,unit,unnecessary,unrelated,unstable,update,updated,updates,upgrade,upstart,upstream,uptime,upwards,usable,usage,user,userland,users,util,utilisation,utilise,utilities,validation,valuable,variable,variety,varnish,vary,vast,vastly,vcard,vehemently,verify,versatile,version,versioning,viability,viable,viewed,viewform,viewport,virtually,visionmedia,visual,visualise,vital,voice,volume,volumes,vows,vowsjs,wait,waiting,wamp,wanted,warning,wastage,ways,weak,weaknesses,wealth,weaved,website,week,weeks,weight,whilst,white,widget,widgets,wiki,wikidot,wikipedia,wise,wmem,woefully,wonders,work,worked,worker,working,workload,workloads,works,worry,worse,worth,wrapper,write,writeup,writing,written,wrong,wrote,yaml,yeah,years,yesterday,yield,ymmv,zone,eladkarako,eladkarakomod,icompile,Elad Karako,Karako Elad,אלעד קרקו,קרקו אלעד,קרקו"    />
<!-- ╔════════════════════════════════════════════════╗
     ║ relation: next/previous/first/last pages.      ║
     ║ (although not advised a single page-article).  ║
     ╚════════════════════════════════════════════════╝ -->
  <link rel="start"                                       href="https://icompile.eladkarako.com/show-hidden-devices-in-windows-device-manager"       />
  <link rel="prev"                                        href="https://icompile.eladkarako.com/disconnect-a-windows-based-virtual-machine-without-logging-off"    />
  <link rel="previous"                                    href="https://icompile.eladkarako.com/disconnect-a-windows-based-virtual-machine-without-logging-off"    />
  <link rel="next"                                        href="https://icompile.eladkarako.com/c-cryptography-code-segments-i-use-a-lot-lately"        />
  <link rel="last"                                        href="https://icompile.eladkarako.com/shealth"        />
  <link rel="up"                                          href="https://icompile.eladkarako.com/" />
  <base target="_top"                                     href="https://icompile.eladkarako.com/" />
<!-- ╔══════╗
     ║ URL. ║
     ╚══════╝ -->
  <link rel="canonical"                                   href="https://icompile.eladkarako.com/varnish-cache-wamp-nodejs-socket-io"         />
  <meta property="og:url"                              content="https://icompile.eladkarako.com/varnish-cache-wamp-nodejs-socket-io"         />
  <meta name="twitter:url"                             content="https://icompile.eladkarako.com/varnish-cache-wamp-nodejs-socket-io"         />
  <meta name="identifier-URL"                          content="https://icompile.eladkarako.com/varnish-cache-wamp-nodejs-socket-io"         />
  <meta name="msapplication-starturl"                  content="https://icompile.eladkarako.com/varnish-cache-wamp-nodejs-socket-io"         />
  <meta name="dcterms.identifier"                      content="https://icompile.eladkarako.com/varnish-cache-wamp-nodejs-socket-io"         />
<!-- ╔════════════════════════════════╗
     ║ Data and Time - UTC. Creation. ║
     ╚════════════════════════════════╝ -->
  <meta name="creation_date"                           content="2014-05-04T17:37:39+00:00"     />
  <meta name="page-datetime"                           content="2014-05-04T17:37:39+00:00"     />
  <meta property="article:published_time"              content="2014-05-04T17:37:39+00:00"     />
  <meta name="dcterms.date"                            content="2014-05-04T17:37:39+00:00"     />
<!-- ╔═════════════════════════════════════╗
     ║ Data and Time - UTC. Last-Modified. ║
     ╚═════════════════════════════════════╝ -->
  <meta name="dcterms.modified"                        content="2014-05-04T17:58:52+00:00"    />
  <meta property="article:modified_time"               content="2014-05-04T17:58:52+00:00"    />
<!-- ╔═════════════════════════════════════════╗
     ║ License - FREE FOR ALL - PUBLIC-DOMAIN! ║
     ╚═════════════════════════════════════════╝ -->
  <link rel="license"                                     href="https://icompile.eladkarako.com/LICENSE" />
<!-- ╔════════════════════╗
     ║ preconnect (self)  ║
     ╚════════════════════╝ -->
  <link rel="dns-prefetch"   crossorigin="anonymous"                                                                                     href="https://icompile.eladkarako.com"                             />
  <link rel="preconnect"     crossorigin="anonymous"                                                                                     href="https://icompile.eladkarako.com"                             />
<!-- ╔═══════════════════════╗
     ║ preconnect (external) ║
     ╚═══════════════════════╝ -->
  <link rel="dns-prefetch"   crossorigin="anonymous"                                                                                     href="https://utteranc.es"                                         />
  <link rel="preconnect"     crossorigin="anonymous"                                                                                     href="https://utteranc.es"                                         />
  <link rel="dns-prefetch"   crossorigin="anonymous"                                                                                     href="www.googletagmanager.com"                                    />
  <link rel="preconnect"     crossorigin="anonymous"                                                                                     href="www.googletagmanager.com"                                    />
  <!-- not being used right now... 
  <link rel="dns-prefetch"   crossorigin="anonymous"                                                                                     href="www.google-analytics.com"                                    />
  <link rel="preconnect"     crossorigin="anonymous"                                                                                     href="www.google-analytics.com"                                    />
  <link rel="dns-prefetch"   crossorigin="anonymous"                                                                                     href="ssl.google-analytics.com"                                    />
  <link rel="preconnect"     crossorigin="anonymous"                                                                                     href="ssl.google-analytics.com"                                    />
  -->
<!-- ╔═════════════════╗
     ║ preload (self)  ║
     ╚═════════════════╝ -->
  <link rel="preload"        crossorigin="anonymous"        type="image/x-icon"                           as="image"                     href="https://icompile.eladkarako.com/favicon.ico"                 />
  <link rel="preload"        crossorigin="anonymous"        type="text/css"               charset="UTF-8" as="style"                     href="https://icompile.eladkarako.com/_resources/index.css"        />
  <link rel="preload"        crossorigin="anonymous"        type="text/javascript"        charset="UTF-8" as="script"                    href="https://icompile.eladkarako.com/_resources/index.js"         />
<!-- ╔════════════════════╗
     ║ preload (external) ║
     ╚════════════════════╝ -->
  <link rel="preload"        crossorigin="anonymous"  type="text/javascript"        charset="UTF-8" as="script"                          href="https://utteranc.es/client.js"                               />
  <link rel="preload"        crossorigin="anonymous"  type="text/javascript"        charset="UTF-8" as="script"                          href="https://www.googletagmanager.com/gtag/js?id=G-M28VNCZS3P"    />
<!-- ╔══════╗
     ║ load ║
     ╚══════╝ -->
  <link rel="icon"           crossorigin="anonymous"        type="image/x-icon"                                                                href="https://icompile.eladkarako.com/favicon.ico" />
  <link rel="shortcut icon"  crossorigin="anonymous"        type="image/x-icon"                                                                href="https://icompile.eladkarako.com/favicon.ico" />
<!-- ╔════════════════════════════════════════════════╗
     ║ page specific image (but favicon is fine too). ║
     ╚════════════════════════════════════════════════╝ -->
  <meta itemprop="image"                                    type="image/png"                                                                content="https://icompile.eladkarako.com/favicon.png" />
  <meta property="og:image"                                 type="image/png"                                                                content="https://icompile.eladkarako.com/favicon.png" />
  <link rel="apple-touch-icon image_src"                    type="image/png"                                                                   href="https://icompile.eladkarako.com/favicon.png" />
  <link rel="stylesheet"     crossorigin="anonymous"        type="text/css"               charset="UTF-8" media="all"                          href="https://icompile.eladkarako.com/_resources/index.css"   />
<!-- ╔══════════════════════════════════════════════════════╗
     ║ OpenSearch (as en external file). type is important. ║
     ╚══════════════════════════════════════════════════════╝ -->
  <link rel="search"                                   href="https://icompile.eladkarako.com/opensearch.xml" type="application/opensearchdescription+xml" title="Search icompile.eladkarako.com" charset="UTF-8" />
<!-- ╔═══════════════════════════════════════╗
     ║ micro-data in a schema-friendly JSON. ║
     ╚═══════════════════════════════════════╝ -->
  <script type="application/ld+json">
{"@context"        : "http://schema.org/"
,"@type"           : "WebSite"
,"name"            : "iCompile"
,"alternateName"   : "iCompile"
,"@id"             : "https://icompile.eladkarako.com/varnish-cache-wamp-nodejs-socket-io"
,"url"             : "https://icompile.eladkarako.com/varnish-cache-wamp-nodejs-socket-io"
,"headline"        : "varnish-cache + WAMP + NodeJS + Socket.IO"
,"description"     : "varnish-cache + WAMP + NodeJS + Socket.IO"
,"datePosted"      : "2014-05-04T17:37:39+00:00"
,"dateCreated"     : "2014-05-04T17:37:39+00:00"
,"datePublished"   : "2014-05-04T17:37:39+00:00"
,"dateModified"    : "2014-05-04T17:58:52+00:00"
,"thumbnailUrl"    : "https://icompile.eladkarako.com/favicon.png"
,"image"           : {"@type"       : "ImageObject"
                     ,"url"         : "https://icompile.eladkarako.com/favicon.png"
                     ,"width"       : 152
                     ,"height"      : 152
                     }
,"potentialAction" : {"@type"       : "SearchAction"
                     ,"target"      : "https://www.google.com/search/?q={query}%20site%3Ahttps%3A%2F%2Ficompile.eladkarako.com%2F"
                     ,"query"       : "required"
                     }
,"author"          : {"@type"       : "Person"
                     ,"name"        : "Elad Karako"
                     ,"givenName"   : "Elad"
                     ,"familyName"  : "Karako"
                     ,"jobTitle"    : "Software Engineer"
                     }
,"license"         : "https://icompile.eladkarako.com/LICENSE"
}
  </script>
<!-- ╔════════════════════╗
     ║ Analytics (no JS). ║
     ╚════════════════════╝ -->
  <noscript><iframe          crossorigin="anonymous"  type="text/html"              charset="UTF-8" loading="eager" lazyload="off"        src="https://www.googletagmanager.com/ns.html?id=G-M28VNCZS3P" referrerpolicy="unsafe-url" sandbox="allow-forms allow-modals allow-orientation-lock allow-pointer-lock allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts allow-top-navigation" seamless="false" height="0" width="0" style="display:none;"></iframe></noscript>
</head>
<body role="main">

<article id="post-0009505229931">
  <header>
    <h1 itemprop="headline">varnish-cache + WAMP + NodeJS + Socket.IO</h1>
    <sup>Posted at <time datetime="2014-05-04T17:58:52+00:00" itemprop="dateModified">Sun, 04 May 2014 17:58:52 GMT</time></sup>
  </header>
  <br/>
  <div itemprop="articleBody"><!--more-->https://www.varnish-cache.org/<br/>
http://codeutopia.net/blog/2012/04/15/how-to-run-apache-and-nodejs-based-sites-on-the-same-server-with-varnish/<br/>
http://socket.io/#how-to-use<br/>
<br/>
You can run Node.js on top of both Nginx and Apache. In fact, both of those servers are frequently used to reverse-proxy to Node apps. For example, see the writeup on using nginx with node here. The reason why PHP is much more common on shared hosting is because its been around for longer. Node was released in 2009, PHP has been around since 1995. In this time hosts have had time to implement support, and haven't had much reason to bother supporting other languages.<br/>
<br/>
There are other ways to deploy node.js apps. You can use PaaS services, like Openshift, Heroku, Appfog, etc.<br/>
<br/>
Node doesn't work like most servers. With IIS and Apache, there is one server running multiple sites, which lends itself to shared environments. With Node, you're running your own server so instead you tend to share resources on a machine.<br/>
<br/>
I can't tell you whether it's worth learning node because I don't know your motivation, but it can expand your career opportunities if you choose to go there, and to expand your skillset.<br/>
<br/>
Here are a couple of hosting options in the low price range.<br/>
<br/>
http://nodester.com/<br/>
<br/>
https://www.nodejitsu.com/<br/>
<br/>
&nbsp;<br/>
<br/>
&nbsp;<br/>
<br/>
&nbsp;<br/>
<br/>
&nbsp;<br/>
<br/>
<header style="color: #000000;"><br/>
<h1 class="entry-title" style="font-weight: 500; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit; color: #1f4561;" title="Optimising NginX, Node.JS and networking for heavy workloads" href="https://engineering.gosquared.com/optimising-nginx-node-js-and-networking-for-heavy-workloads" rel="bookmark">Optimising NginX, Node.JS and networking for heavy workloads</a></h1><br/>
<h2 class="the_subtitle" style="font-weight: 200; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit; color: #1f4561;" href="https://engineering.gosquared.com/optimising-nginx-node-js-and-networking-for-heavy-workloads">Optimising for scale</a></h2><br/>
</header><section class="entry-content" style="color: #3a3f42;"><br/>
<p style="font-weight: inherit; font-style: inherit;">Used in conjunction, NginX and Node.JS are the perfect partnership for high-throughput web applications. They're both built using event-driven design principles and are able to scale to levels far beyond the classic <a style="font-weight: inherit; font-style: inherit; color: #3a3f42;" href="http://en.wikipedia.org/wiki/C10k_problem" target="_blank">C10K</a> limitations afflicting standard web servers such as Apache. Out-of-the-box configuration will get you pretty far, but when you need to start serving upwards of thousands of requests per second on commodity hardware, there's some extra tweaking you must perform to squeeze every ounce of performance out of your servers.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">This article assumes you're using NginX's HttpProxyModule to <a style="font-weight: inherit; font-style: inherit; color: #3a3f42;" href="https://calomel.org/nginx.html" target="_blank">proxy</a>your traffic to one or more upstream node.js servers. We'll cover tuning sysctl settings in Ubuntu 10.04 and above, as well as node.js application and NginX tuning. You may be able to achieve similar results if you're using a Debian Linux distribution, but YMMV if you're using something else.</p><br/>
<br/>
<h2 style="font-style: inherit; color: #333332;">Tuning the network</h2><br/>
<p style="font-weight: inherit; font-style: inherit;">Meticulous configuration of Nginx and Node.js would be futile without first understanding and optimising the transport mechanism over which traffic data is sent. Most commonly, NginX will be connected to your web clients and your upstream applications via TCP sockets.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">Your system imposes a variety of thresholds and limits on TCP traffic, dictated by its kernel parameter configuration. The default settings are designed for accommodating generic networking use. They are not necessarily geared up for high-volumes of short-lived connections handled by a web server.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">The parameters listed here are the main candidates for tuning TCP throughput of a server. To have these take effect, you can drop them in your <code style="font-weight: inherit; font-style: inherit;">/etc/sysctl.conf</code> file, or a new config file such as <code style="font-weight: inherit; font-style: inherit;">/etc/sysctl.d/99-tuning.conf</code> and run <code style="font-weight: inherit; font-style: inherit;">sysctl -p</code> to have the kernel pick them up. We use a<a style="font-weight: inherit; font-style: inherit; color: #3a3f42;" href="https://github.com/spheromak/sysctl-cookbook" target="_blank">syctl-cookbook</a> to do the hard work.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">Please note the following values are guidelines, and you should be able to use them safely, but you are encouraged to research what each one means so you can choose a value appropriate for your workload, hardware and use-case.</p><br/>
<br/>
<pre><code class="language-shell" style="font-weight: inherit; font-style: inherit; color: black;">net.ipv4.ip_local_port_range='1024 65000'<br/>
net.ipv4.tcp_tw_reuse='1'<br/>
net.ipv4.tcp_fin_timeout='15'<br/>
net.core.netdev_max_backlog='4096'<br/>
net.core.rmem_max='16777216'<br/>
net.core.somaxconn='4096'<br/>
net.core.wmem_max='16777216'<br/>
net.ipv4.tcp_max_syn_backlog='20480'<br/>
net.ipv4.tcp_max_tw_buckets='400000'<br/>
net.ipv4.tcp_no_metrics_save='1'<br/>
net.ipv4.tcp_rmem='4096 87380 16777216'<br/>
net.ipv4.tcp_syn_retries='2'<br/>
net.ipv4.tcp_synack_retries='2'<br/>
net.ipv4.tcp_wmem='4096 65536 16777216'<br/>
vm.min_free_kbytes='65536'<br/>
</code></pre><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;">Higlighting a few of the important ones…</p><br/>
<br/>
<h5 style="font-weight: inherit; font-style: inherit;">net.ipv4.ip_local_port_range</h5><br/>
<p style="font-weight: inherit; font-style: inherit;">To serve a client request via an upstream application, NginX must open 2 TCP connections; one for the client, one for the connection to the upstream. If the server receives many connections, this can rapidly saturate the system's available port capacity. The net.ipv4.ip_local_port_range directive increases the range to much larger than the default, so we have room for more allocated ports. If you're seeing errors in your /var/log/syslog such as: "<code style="font-weight: inherit; font-style: inherit;">possible SYN flooding on port 80. Sending cookies</code>" it might mean the system can't find an available port for the pending connection. Increasing the capacity will help alleviate this symptom.</p><br/>
<br/>
<h5 style="font-weight: inherit; font-style: inherit;">net.ipv4.tcp_tw_reuse</h5><br/>
<p style="font-weight: inherit; font-style: inherit;">When the server has to cycle through a high volume of TCP connections, it can build up a large number of connections in TIME_WAIT state. TIME_WAIT means a connection is closed but the allocated resources are yet to be released. Setting this directive to 1 will tell the kernel to try to recycle the allocation for a new connection when safe to do so. This is cheaper than setting up a new connection from scratch.</p><br/>
<br/>
<h5 style="font-weight: inherit; font-style: inherit;">net.ipv4.tcp_fin_timeout</h5><br/>
<p style="font-weight: inherit; font-style: inherit;">The minimum number of seconds that must elapse before a connection in TIME_WAIT state can be recycled. Lowering this value will mean allocations will be recycled faster.</p><br/>
<br/>
<h4 style="font-style: inherit; color: #333332;">How to check connection status</h4><br/>
<p style="font-weight: inherit; font-style: inherit;">Using netstat:</p><br/>
<p style="font-weight: inherit; font-style: inherit;"><code class="language-shell" style="font-weight: inherit; font-style: inherit; color: black;">netstat -tan | awk '{print $6}' | sort | uniq -c</code></p><br/>
<p style="font-weight: inherit; font-style: inherit;">Using ss:</p><br/>
<p style="font-weight: inherit; font-style: inherit;"><code class="language-shell" style="font-weight: inherit; font-style: inherit; color: black;">ss -s</code></p><br/>
<br/>
<h2 style="font-style: inherit; color: #333332;">Nginx</h2><br/>
<p style="font-weight: inherit; font-style: inherit;">As load on our web servers continually increased, we started hitting some odd limitations in our NginX cluster. I noticed connections were being throttled or dropped, and the kernel was complaining about syn flooding with the error message I mentioned earlier. Frustratingly, I knew the servers could handle more, because the load average and CPU usage was negligible.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">On further investigation, I tracked down an extraordinarily high number of connections idling in TIME_WAIT state. This was <code style="font-weight: inherit; font-style: inherit;">ss</code> output from one of the servers:</p><br/>
<br/>
<pre><code class="language-shell" style="font-weight: inherit; font-style: inherit; color: black;">ss -s<br/>
Total: 388 (kernel 541)<br/>
TCP:   47461 (estab 311, closed 47135, orphaned 4, synrecv 0, timewait 47135/0), ports 33938<br/>
<br/>
Transport Total     IP        IPv6<br/>
*          541       -         -        <br/>
RAW        0         0         0        <br/>
UDP        13        10        3        <br/>
TCP        326       325       1        <br/>
INET       339       335       4        <br/>
FRAG       0         0         0<br/>
</code></pre><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;">47,135 connections in TIME_WAIT! Moreover, <code style="font-weight: inherit; font-style: inherit;">ss</code> indicates that they are all closed connections. This suggests the server is burning through a large portion of the available port range, which implies that it is allocating a new port for each connection it's handling. Tweaking the networking settings helped firefight the problem a bit, but the socket range was still getting saturated.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">After some digging around, I uncovered some documentation about an upstream <a style="font-weight: inherit; font-style: inherit; color: #3a3f42;" href="http://nginx.org/en/docs/http/ngx_http_upstream_module.html#keepalive" target="_blank">keepalive</a> directive. The docs state:</p><br/>
<br/>
<blockquote style="font-weight: inherit; font-style: italic;"><br/>
<p style="font-weight: inherit; font-style: inherit;"><em style="font-weight: inherit;">Sets the maximum number of idle keepalive connections to upstream servers that are retained in the cache per one worker process</em></p><br/>
</blockquote><br/>
<p style="font-weight: inherit; font-style: inherit;">This is interesting. In theory, this will help minimise connection wastage by pumping requests down connections that have already been established and cached. Additionally, the documentation also states that the proxy_http_version directive should be set to "1.1" and the "Connection" header cleared. On further research, it's clear this is a good idea since HTTP/1.1 optimises TCP connection usage much <a style="font-weight: inherit; font-style: inherit; color: #3a3f42;" href="http://www8.org/w8-papers/5c-protocols/key/key.html#SECTION00050000000000000000" target="_blank">more efficiently</a> than HTTP/1.0, which is the default in Nginx Proxy.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">Making both of these changes, our upstream config looks more like:</p><br/>
<br/>
<pre><code class="language-shell" style="font-weight: inherit; font-style: inherit; color: black;">upstream backend_nodejs {<br/>
  server nodejs-3:5016 max_fails=0 fail_timeout=10s;<br/>
  server nodejs-4:5016 max_fails=0 fail_timeout=10s;<br/>
  server nodejs-5:5016 max_fails=0 fail_timeout=10s;<br/>
  server nodejs-6:5016 max_fails=0 fail_timeout=10s;<br/>
  keepalive 512;<br/>
}<br/>
</code></pre><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;">I made the recommended changes to the proxy directives in the server stanza. While I was at it, I added a <em style="font-weight: inherit;">proxy_next_upstream</em> directive to skip out-of-service servers (helping with <a style="font-weight: inherit; font-style: inherit; color: #3a3f42;" href="http://blog.argteam.com/coding/hardening-node-js-for-production-part-3-zero-downtime-deployments-with-nginx/" target="_blank">zero-downtime</a> deploys), tweaked the client <em style="font-weight: inherit;">keepalive_timeout</em>, and disabled all logging. The config now looks more like:</p><br/>
<br/>
<pre><code class="language-shell" style="font-weight: inherit; font-style: inherit; color: black;">server {<br/>
  listen 80;<br/>
  server_name fast.gosquared.com;<br/>
<br/>
  client_max_body_size 16M;<br/>
  keepalive_timeout 10;<br/>
<br/>
  location / {<br/>
    proxy_next_upstream error timeout http_500 http_502 http_503 http_504;<br/>
    proxy_set_header   Connection "";<br/>
    proxy_http_version 1.1;<br/>
    proxy_pass http://backend_nodejs;<br/>
  }<br/>
<br/>
  access_log off;<br/>
  error_log /dev/null crit;<br/>
}<br/>
</code></pre><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;">When I pushed out the new configuration to the nginx cluster, I noticed a <strong style="font-style: inherit;">90% reduction</strong> in occupied sockets. Nginx is now able to use far fewer connections to send many requests. Here is the new <code style="font-weight: inherit; font-style: inherit;">ss</code> output:</p><br/>
<br/>
<pre><code class="language-shell" style="font-weight: inherit; font-style: inherit; color: black;">ss -s<br/>
<br/>
Total: 558 (kernel 604)<br/>
TCP:   4675 (estab 485, closed 4183, orphaned 0, synrecv 0, timewait 4183/0), ports 2768<br/>
<br/>
Transport Total     IP        IPv6<br/>
*          604       -         -        <br/>
RAW        0         0         0        <br/>
UDP        13        10        3        <br/>
TCP        492       491       1        <br/>
INET       505       501       4   <br/>
</code></pre><br/>
<h2 style="font-style: inherit; color: #333332;"></h2><br/>
<h2 style="font-style: inherit; color: #333332;">Node.js</h2><br/>
<p style="font-weight: inherit; font-style: inherit;">Thanks to its event-driven design that can handle I/O asynchronously, Node.js is geared up to handle high volumes of connections and requests out of the box. There are additional <a style="font-weight: inherit; font-style: inherit; color: #3a3f42;" href="http://engineering.linkedin.com/nodejs/blazing-fast-nodejs-10-performance-tips-linkedin-mobile" target="_blank">tweaks and observations</a>that can be made. We're going to focus on node.js processes.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">Node is single-threaded and doesn't automatically make use of more than a single core in your potentially multi-core machine. This means unless you design it differently, your application won't take full advantage of the available capacity the server hosting it has to offer.</p><br/>
<br/>
<h4 style="font-style: inherit; color: #333332;">Clustering node processes</h4><br/>
<p style="font-weight: inherit; font-style: inherit;">It's possible to modify your application so that it forks a number of threads that all accept() data on the same port and efficiently load balance it across multiple CPU cores. Node has a core module called<a style="font-weight: inherit; font-style: inherit; color: #3a3f42;" href="http://nodejs.org/docs/latest/api/cluster.html" target="_blank">cluster</a> that offers all of the tools you need to achieve this, however it'll take a bit of elbow grease to work it into your application. If you're using<a style="font-weight: inherit; font-style: inherit; color: #3a3f42;" href="http://expressjs.com/" target="_blank">express</a>, eBay have built a module for it called <a style="font-weight: inherit; font-style: inherit; color: #3a3f42;" href="http://ql-io.github.com/cluster2/" target="_blank">cluster2</a>.</p><br/>
<br/>
<h4 style="font-style: inherit; color: #333332;">Beware of the context switch</h4><br/>
<p style="font-weight: inherit; font-style: inherit;">When running multiple processes on your machine, try to make sure each CPU core will be kepy busy by a single application thread at a time. As a general rule, you should look to spawn N-1 application processes, where N is the number of available CPU cores. That way, each process is guaranteed to get a good slice of one core, and there's one spare for the kernel scheduler to run other server tasks on. Additionally, try to make sure the server will be running little or no work other than your Node.JS application, so processes don't fight for CPU.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">We made a mistake where we deployed two busy node.js applications to our servers, both apps spawning N-1 processes each. The applications' processes started vehemently competing for CPU, resulting in CPU load and usage increasing dramatically. Even though we were running these on beefy 8-core servers, we were paying a noticeable penalty due to context switching. Context switching is the behaviour whereby the CPU suspends one task in order to work on another. When context switching, the kernel must suspend all state for one process while it loads and executes state for another. After simply reducing the number of processes the applications spawned such that they each shared an equal number of cores, load dropped significantly:</p><br/>
<p style="font-weight: inherit; font-style: inherit;"><img loading="lazy" lazyload="on"  style="font-weight: inherit; font-style: inherit;" src="https://s3.amazonaws.com/static.gosquared.com/images/blog/post-content/nodejs-load-reduction.png" alt="load-reduction" width="481" height="242" /></p><br/>
<p style="font-weight: inherit; font-style: inherit;">Notice how load decreases as the number of processes running (the blue line) crosses beneath the number of CPU cores (the red line). We noticed a similar improvement across all other servers. Since the amount of work spread between all the servers remained constant, this efficiency must have been due to reduced context switch overhead.</p><br/>
<br/>
<h2 style="font-style: inherit; color: #333332;">Additional links and references</h2><br/>
<ul style="font-weight: inherit; font-style: inherit;"><br/>
	<li style="font-weight: inherit; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit; color: #3a3f42;" href="https://engineering.gosquared.com/10-vital-aspects-of-building-a-node-js-application/" target="_blank">10 Vital Aspects of building a Node.JS application</a></li><br/>
	<li style="font-weight: inherit; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit; color: #3a3f42;" href="http://blog.argteam.com/coding/hardening-node-js-for-production-part-2-using-nginx-to-avoid-node-js-load/" target="_blank">Using NginX to avoid node.js load</a></li><br/>
	<li style="font-weight: inherit; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit; color: #3a3f42;" href="https://gist.github.com/4547269" target="_blank">Commands to analyse system socket usage</a></li><br/>
	<li style="font-weight: inherit; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit; color: #3a3f42;" href="http://www.speedguide.net/articles/linux-tweaking-121" target="_blank">TCP/IP setting reference</a></li><br/>
	<li style="font-weight: inherit; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit; color: #3a3f42;" href="http://russ.garrett.co.uk/2009/01/01/linux-kernel-tuning/" target="_blank">Linux kernel tuning</a></li><br/>
</ul><br/>
&nbsp;<br/>
<br/>
&nbsp;<br/>
<br/>
&nbsp;<br/>
<br/>
<header style="color: #000000;"><br/>
<h1 class="entry-title" style="font-weight: 500; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit; color: #1f4561;" title="5 steps to making a Node.js frontend app 10x faster" href="https://engineering.gosquared.com/making-dashboard-faster" rel="bookmark">5 steps to making a Node.js frontend app 10x faster</a></h1><br/>
<h2 class="the_subtitle" style="font-weight: 200; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit; color: #1f4561;" href="https://engineering.gosquared.com/making-dashboard-faster">How we made GoSquared 10x faster</a></h2><br/>
</header><section class="entry-content"><br/>
<p style="font-weight: inherit; font-style: inherit;"><img loading="lazy" lazyload="on"  style="font-weight: inherit; font-style: inherit;" src="https://static.gosquared.com/images/liquidicity/14_03_19_dashboardfaster_01.png" alt="Making GoSquared Dashboard faster" /></p><br/>
<p style="font-weight: inherit; font-style: inherit;">Over the last couple of months we've done a huge amount to make Dashboard (the node.js application that powers the Now, Trends and Ecommerce front-ends) much faster. Here's a brief summary of our story in making that happen.</p><br/>
<br/>
<h2 style="font-style: inherit; color: #333332;">What it used to be like</h2><br/>
<p style="font-weight: inherit; font-style: inherit;">Back in November, loading any dashboard would take anywhere upwards of 30 seconds. Simply loading the HTML page itself would take a minimum of 10 seconds, then the application would request several other JavaScript and CSS files, each with a response time averaging 5 seconds.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">Clearly this was not acceptable, so we set about doing everything we could think of to make things faster.</p><br/>
<br/>
<h2 style="font-style: inherit; color: #333332;">Step 1: Parallelize Everything</h2><br/>
<p style="font-weight: inherit; font-style: inherit;">In order to render the HTML page for any dashboard, the node.js application needs to retrieve a lot of data for the dashboard in question.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">At minimum this means it needs to retrieve the data from the user's current browsing session to check they're logged in and it needs to pull in data about the user (e.g. the user's name, which sites they have access to, their API key and the parameters of their GoSquared subscription), and about the site in question for the dashboard (site name, unique token etc).</p><br/>
<p style="font-weight: inherit; font-style: inherit;">In order to retrieve this data, the application needed to make several calls to internal API functions, many of which could take up to 2 seconds to complete. Each request was made by a separate <a style="font-weight: inherit; font-style: inherit;" href="http://expressjs.com/">Express</a>middleware, which meant they were running in series. Each request would wait for the previous one to complete before starting.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">Since node.js is perfectly suited to running multiple asynchronous functions in parallel, and since a lot of these internal API requests didn't depend on each other, it made sense to parallelize them — fire off all the requests at once and then continue once they've all completed. We achieved this with the aid of the (incredibly useful) <a style="font-weight: inherit; font-style: inherit;" href="https://github.com/caolan/async">async</a> module:</p><br/>
<p style="font-weight: inherit; font-style: inherit;">So instead of:</p><br/>
<br/>
<pre><code class=" language-javascript" style="font-weight: inherit; font-style: inherit;">app<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span><span class="token function" style="font-weight: inherit; font-style: inherit;">use<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span>getUser<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
app<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span><span class="token function" style="font-weight: inherit; font-style: inherit;">use<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span>getSiteList<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
app<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span><span class="token function" style="font-weight: inherit; font-style: inherit;">use<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span>getCurrentSite<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
app<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span><span class="token function" style="font-weight: inherit; font-style: inherit;">use<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span>getSubscription<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span></code></pre><br/>
<p style="font-weight: inherit; font-style: inherit;">… we could do something like this:</p><br/>
<br/>
<pre><code class=" language-javascript" style="font-weight: inherit; font-style: inherit;"><span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">function</span> <span class="token function" style="font-weight: inherit; font-style: inherit;">parallel<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span>middlewares<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">{</span><br/>
  <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">return</span> <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">function</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span>req<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> res<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> next<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">{</span><br/>
    async<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span><span class="token function" style="font-weight: inherit; font-style: inherit;">each<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span>middlewares<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">function</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span>mw<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> cb<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">{</span><br/>
      <span class="token function" style="font-weight: inherit; font-style: inherit;">mw<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span>req<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> res<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> cb<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
    <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">}</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> next<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
  <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">}</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">}</span><br/>
<br/>
app<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span><span class="token function" style="font-weight: inherit; font-style: inherit;">use<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span><span class="token function" style="font-weight: inherit; font-style: inherit;">parallel<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">[</span><br/>
  getUser<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span><br/>
  getSiteList<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span><br/>
  getCurrentSite<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span><br/>
  getSubscription<br/>
<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">]</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span></code></pre><br/>
<p style="font-weight: inherit; font-style: inherit;">Straight away this cut our average response time down from 10 seconds to roughly 1.5 seconds. But we knew we could still do better.</p><br/>
<br/>
<h2 style="font-style: inherit; color: #333332;">Step 2: Cache, Cache, Cache</h2><br/>
<p style="font-weight: inherit; font-style: inherit;">Even once we'd parallelized all of our internal data-fetching, loading a dashboard was still pretty slow. The reason for this was because not only was the application fetching all this data for the initial page load, it was also fetching it for a lot of subsequent JavaScript requests (at this point we were still limiting widgets in the dashboard based on GoSquared plan, so we needed to restrict who had access to which resources). And every one of these subsequent requests also had an average response time of about 1.5 seconds.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">The solution to this was to cache any fetched data that wasn't likely to change. A user isn't going to upgrade or downgrade their GoSquared subscription in the 2 seconds it takes for the dashboard to load its JS, so there's no point fetching subscription data again if we've already fetched it once.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">So, we went ahead and cached all the data we could, cutting response times down from 1.5 seconds to about 500ms on any requests which already had the data cached.</p><br/>
<br/>
<h2 style="font-style: inherit; color: #333332;">Step 3: Intelligent JS and CSS loading on the front-end</h2><br/>
<p style="font-weight: inherit; font-style: inherit;">The front-end of the dashboard application has a lot of interconnected components. The JavaScript for the application falls into three main parts: libraries (such as jQuery, D3 etc.), the main application core, and widgets (each widget in the application is modularised and has its own code). Code in each of these parts is edited in very different ways: libraries are barely touched and are updated at most once a month; the core is changed several times a day; widgets can vary from receiving several changes in a day to not being touched in weeks.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">Originally we bundled all our libraries into the core application bundle (which was included via a script tag on the page), and all of the widgets into a secondary bundle which was loaded dynamically. This meant that even with good cache control, any tiny change we made to the core code would mean browsers would have to download all of the (unchanged) library code, or any change to one widget would require downloading <em style="font-weight: inherit;">all</em>of the widgets again.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">One way around this problem would be to break each individual component into its own file and include them all individually — that way any files that don't get changed frequently can sit in the browser's HTTP cache and not be requested. The problem with this, though, is that there would be a <em style="font-weight: inherit;">lot</em> of files, some of them incredibly small. And (especially on mobile browsers), the overhead of loading that many individual resources vastly outweights the extra overhead we had before of re-downloading unchanged content.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">We eventually came up with a compromise solution based on Addy Osmani's <a style="font-weight: inherit; font-style: inherit;" href="http://addyosmani.github.io/basket.js/">basket.js</a>, using a combination of server-side script concatenation and localStorage for caching. In a nutshell, the page includes a lightweight loader script, which figures out which JS and CSS it has already cached and which needs to be fetched. The loader then requests all the resources it needs from the server in one request, and saves all the resources into localStorage under individual keys. This gives us a great compromise between cutting down the number of HTTP requests while still being able to maintain cacheability, and not re-downloading code unnecessarily when it hasn't changed. Addtionally, after running a few benchmarks, we found that localStorage is (sometimes) actually <em style="font-weight: inherit;">faster</em> than the native HTTP cache, especially on mobile browsers.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">Along with this, we also switched all of our static (JS and CSS) asset loading to be served through <a style="font-weight: inherit; font-style: inherit;" href="http://aws.amazon.com/cloudfront/">CloudFront</a>, Amazon Web Service's content delivery network. This means content is served from the nearest possible geographic location to the user, cutting down request latency from as high as 2500ms (in places such as Singapore) to tens of milliseconds.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">We also introduced some optimizations to prevent loading or storing duplicate code. For example, the Languages widget uses exactly the same code in Now, Trends and Ecommerce. By de-duplicating the caching and requests based on a digest of each resource's contents, we were able to cut out unnecessary requests and storage.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">With these intelligent changes to resource loading we were able to cut down the total number of HTTP requests necessary to render the dashboard to one (just the page itself), which meant that for users quickly switching between dashboards for different sites, each dashboard would load within a few seconds.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">But we could do even better.</p><br/>
<br/>
<h2 style="font-style: inherit; color: #333332;">Step 4: Cut out the middle-man for fetching data</h2><br/>
<p style="font-weight: inherit; font-style: inherit;">All the user, site and subscription data described in the first two steps was being fetched via a secure internal HTTP API to our internal account system, which at the time was written in some old, clunky, slow PHP. As part of our <a style="font-weight: inherit; font-style: inherit;" href="https://engineering.gosquared.com/admin-systems-in-node">extensive rewrite</a> of that whole system from PHP to Node, we were also able to cut out the internal HTTP component completely, instead including a node module directly in the dashboard application and requesting our databases directly. This allowed us much finer-grained control over exactly what data we were fetching, as well as eliminating a huge amount of overhead.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">With this significant change, we were able to reduce our average response time (even without the caching described in Step 2), to 25ms.</p><br/>
<br/>
<h2 style="font-style: inherit; color: #333332;">Step 5: Do More on the Client</h2><br/>
<p style="font-weight: inherit; font-style: inherit;">Thanks to all the changes we'd made up to this point, all that was different between different dashboards for different sites was a config object passed to the loader on initialization. It didn't make sense, therefore, to be reloading the entire page when simply switching between sites or between Now and Trends, if all of the important resources had already been loaded. With a little bit of rearranging of the config object, we were able to include all of the data necessary to load any of the dashboards accessible to the user. Throw in some <a style="font-weight: inherit; font-style: inherit;" href="https://developer.mozilla.org/en-US/docs/Web/Guide/API/DOM/Manipulating_the_browser_history">HTML5 History</a> with pushState and popState, and we're now able to switch between sites or dashboards without making a single HTTP request or even fetching scripts out of the localStorage cache. This means that switching between dashboards now takes a couple of hundred milliseconds, rather than several seconds.</p><br/>
<br/>
<h2 style="font-style: inherit; color: #333332;">What else?</h2><br/>
<p style="font-weight: inherit; font-style: inherit;">So far all this has been about reducing load times and getting to a usable dashboard in the shortest time possible. But we've also done a lot to optimise the application itself to make sure it's as fast as possible. In summary:</p><br/>
<br/>
<ul style="font-weight: inherit; font-style: inherit;"><br/>
	<li style="font-weight: inherit; font-style: inherit;"><br/>
<p style="font-weight: inherit; font-style: inherit;"><strong style="font-style: inherit;">Don't use big complex libraries if you don't have to</strong> — for example, jQuery UI is great for flexibility and working around all manner of browser quirks, but we don't support a lot of the older browsers so the code bloat is unnecessary. We were able to replace our entire usage of jQuery UI with some clever thinking and 100-or-so lines of concise JS (we also take advantage of things like HTML5's native drag-and-drop).</p><br/>
</li><br/>
	<li style="font-weight: inherit; font-style: inherit;"><br/>
<p style="font-weight: inherit; font-style: inherit;"><strong style="font-style: inherit;">Even respectable libraries have their weak spots</strong> — for example we use <a style="font-weight: inherit; font-style: inherit;" href="http://momentjs.com/">moment</a> with <a style="font-weight: inherit; font-style: inherit;" href="http://momentjs.com/timezone/">moment-timezone</a> for a lot of our date and time handling. However moment-timezone is woefully inefficient (especially on mobile) if you're using it a <em style="font-weight: inherit;">lot</em>. With a little bit of hacking we added a few optimizations of our own and made it much better for our use-case.</p><br/>
</li><br/>
	<li style="font-weight: inherit; font-style: inherit;"><br/>
<p style="font-weight: inherit; font-style: inherit;"><strong style="font-style: inherit;">Slow animations make everything feel slow</strong> — a lot of studies have been posted about this in the past, and it really makes a difference. Simply reducing some CSS transition times from 500ms to 250ms, and cutting others out entirely, made the whole dashboard <em style="font-weight: inherit;">feel</em> snappier and more responsive.</p><br/>
</li><br/>
	<li style="font-weight: inherit; font-style: inherit;"><br/>
<p style="font-weight: inherit; font-style: inherit;"><strong style="font-style: inherit;">Instant visual feedback</strong> — one of the big things we found when using Trends was that switching between time frames just felt slow. It took under a second, but because there was a noticeable delay between clicking on the timeframe selector and anything actually happening, things felt broken. Fetching new data from our API is always going to take some time — it's not going to be instant. So instead we introduced the loading spinner on each widget. Nothing is actually any faster, but the whole experience feels more responsive. There is immediate visual feedback when you click the button, so you know it's working properly.</p><br/>
</li><br/>
	<li style="font-weight: inherit; font-style: inherit;"><br/>
<p style="font-weight: inherit; font-style: inherit;"><strong style="font-style: inherit;">Flat design is actually really handy for performance</strong> — it may well just be a design trend, but cutting out superficial CSS gradients and box shadows does wonders for render performance. If the browser doesn't have to use CPU power to render all these fancy CSS effects, you get an instant boost to render performance.</p><br/>
</li><br/>
</ul><br/>
<p style="font-weight: inherit; font-style: inherit;"><img loading="lazy" lazyload="on"  style="font-weight: inherit; font-style: inherit;" src="https://static.gosquared.com/images/screens/now-standard.png" alt="Now dashboard in action" /></p><br/>
<br/>
<h2 style="font-style: inherit; color: #333332;">What next?</h2><br/>
<p style="font-weight: inherit; font-style: inherit;">Even after all these optimizations and tweaks, we're well aware that there's still plenty of room for improvement. Especially on mobile, where CPU power, memory, rendering performance, latency and bandwidth are all significantly more limited than they are on the desktop. We'll continue improving everything we can, so stay tuned for further updates!</p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<br/>
<header style="color: #000000;"><br/>
<h1 class="entry-title" style="font-weight: 500; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit; color: #1f4561;" title="So long, Campfire. Hello Slack!" href="https://engineering.gosquared.com/switching-from-campfire-to-slack" rel="bookmark">So long, Campfire. Hello Slack!</a></h1><br/>
<h2 class="the_subtitle" style="font-weight: 200; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit; color: #1f4561;" href="https://engineering.gosquared.com/switching-from-campfire-to-slack">How we completely changed our internal communication in one morning</a></h2><br/>
</header><section class="entry-content"><br/>
<p style="font-weight: inherit; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit;" title="Check out Slack now!" href="https://slack.com/r/024ge12x-0253s6ep" target="_blank"><img loading="lazy" lazyload="on"  style="font-weight: inherit; font-style: inherit;" src="https://static.gosquared.com/images/liquidicity/14_02_13_slack_01.png" alt="Moving from Campfire to Slack" /></a></p><br/>
<p style="font-weight: inherit; font-style: inherit;">Here at GoSquared, we've long been fans of <a style="font-weight: inherit; font-style: inherit;" href="https://campfirenow.com/">Campfire</a> by 37Signals. We've been using it for a couple of years for our internal team chat, along with the help of our friendly company <a style="font-weight: inherit; font-style: inherit;" href="http://hubot.github.com/">Hubot</a> (an awesome chatbot made by GitHub). However, there have always been a couple of things we haven't been so keen on: there's a roughly five-second delivery lag on messages (which means you can be waiting about ten seconds for a reply from Hubot); there's no support for one-on-one chats or private groups (we used Skype for this); the <a style="font-weight: inherit; font-style: inherit;" href="https://wiki.jenkins-ci.org/display/JENKINS/Campfire+Plugin">Jenkins Plugin</a>(which we used to track all our code builds and deploys) has been<a style="font-weight: inherit; font-style: inherit;" href="https://issues.jenkins-ci.org/browse/JENKINS-19590">broken</a> for months; the official first-party is, well, a bit rubbish (although <a style="font-weight: inherit; font-style: inherit;" href="http://giantcomet.com/flint/mac/">Flint</a> for Mac and iOS is excellent); and there's no native app for Android at all.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">So, with the <a style="font-weight: inherit; font-style: inherit;" href="http://37signals.com/">news</a> that 37signals is no longer focusing on Campfire, we took the opportunity to investigate other options.</p><br/>
<br/>
<h2 style="font-style: inherit; color: #333332;">Enter Slack</h2><br/>
<p style="font-weight: inherit; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit;" title="Learn more about Slack" href="https://slack.com/r/024ge12x-0253s6ep" target="_blank">Slack</a> is a relatively-new (only just today out of limited preview) communication platform that serves as a drop-in replacement for Campfire. We've actually been on the limited preview since November, but we thought we'd give it a shot and experiment with it. In a somewhat bold move last Friday, we decided to ditch Campfire completely for the morning and communicate only in Slack, to see how easy it was to use. And, well, we never looked back!</p><br/>
<p style="font-weight: inherit; font-style: inherit;">Slack is everything we need for team communication. It has group chats (or "channels"), which you divide by purpose (for example, we have a development channel, a design channel, a channel for random silly stuff, and several others). It has one-on-one direct messages, meaning we can do away with Skype and communicate solely in one place. It has native Mac, iOS and Android apps.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">And it's <em style="font-weight: inherit;">fast</em>. Boy is it fast. It may not seem like much, but coming from Campfire, where every message would take several seconds to be delivered (a bit ridiculous if you're just chatting to the person sitting right next to you), having a chat where messages come through as good as instantaneously, or where you only have to wait half a second for a reply from Hubot, makes a huge difference.</p><br/>
<br/>
<h2 style="font-style: inherit; color: #333332;">Integrate ALL OF THE THINGS</h2><br/>
<p style="font-weight: inherit; font-style: inherit;"><img loading="lazy" lazyload="on"  style="font-weight: inherit; font-style: inherit;" src="https://static.gosquared.com/images/liquidicity/14_02_13_slack_hubot_01.jpeg" alt="Hubot integrate all of the things" /></p><br/>
<p style="font-weight: inherit; font-style: inherit;">The best part of all is all the available <a style="font-weight: inherit; font-style: inherit;" href="https://slack.com/integrations">service integrations</a>. We now have a one-stop-shop with all our GitHub activity, Jenkins builds, PagerDuty notifications, Desk.com customer support and much more. We even got to keep Hubot and all our custom commands thanks to their <a style="font-weight: inherit; font-style: inherit;" href="https://github.com/tinyspeck/hubot-slack">Hubot adapter</a>. And it was all <em style="font-weight: inherit;">ridiculously</em> easy to set up. Not only did we switch our whole team to Slack in that one morning, we also got almost all of our core service notifications set up too. And we're still adding the odd extra one every now and again.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">It's still early days for GoSquared and Slack, but we love what we see so far. We've been using it for less than a week and it's already completely reinvented the way we communicate as a team.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">Stay tuned to the Engineering Blog for updates on how we use Slack as a team. Also keep an eye out if you're more interested in the technical stuff, like our service integrations or how we use Hubot — we'll be posting more abuot that in the next few days!</p><br/>
<p style="font-weight: inherit; font-style: inherit;"><em style="font-weight: inherit;">P.S. Just yesterday, Slack launched publicly – if you'd like to get $100 of service credit, and reward us with the same, then <a style="font-weight: inherit; font-style: inherit;" href="https://slack.com/r/024ge12x-0253s6ep" target="_blank">sign up here and do us both a favour</a>.</em></p><br/>
<br/>
</section><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<br/>
<header style="color: #000000;"><br/>
<h1 class="entry-title" style="font-weight: 500; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit; color: #1f4561;" title="Using secure sessions behind an HTTP proxy" href="https://engineering.gosquared.com/secure-sessions-http-proxy" rel="bookmark">Using secure sessions behind an HTTP proxy</a></h1><br/>
<h2 class="the_subtitle" style="font-weight: 200; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit; color: #1f4561;" href="https://engineering.gosquared.com/secure-sessions-http-proxy">Making things more secure</a></h2><br/>
</header><section class="entry-content"><br/>
<p style="font-weight: inherit; font-style: inherit;">GoSquared is served entirely via HTTPS, so it was a logical and easy decision to modify our user sessions to use secure cookies. A couple of lines of configuration later, and we were good to go.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">Not quite.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">We use Node.js extensively, and <a style="font-weight: inherit; font-style: inherit;" href="http://www.senchalabs.org/connect/session.html" target="_blank">Connect.session</a>, which is used by Express, will refuse to set secure cookies when the connection isn't encrypted (req.connection.encrypted) unless the option of <code style="font-weight: inherit; font-style: inherit;">proxy</code> is set to true and the <code style="font-weight: inherit; font-style: inherit;">x-forwarded-proto</code> is <code style="font-weight: inherit; font-style: inherit;">https</code>. This is not the case with standard secure cookies, but it's been coded into Connect probably for security reasons.</p><br/>
<br/>
<h2 style="font-style: inherit; color: #333332;">Why does this matter? Isn't everything is served via https anyway?</h2><br/>
<p style="font-weight: inherit; font-style: inherit;">Of course, but everything is also served via an ELB which proxies to our nginx cluster, which in turn proxies to our apps servers via internal http connections. The fix is trivial as it's easy to set/modify headers in nginx, making the header validation in Connect quite pointless –<code style="font-weight: inherit; font-style: inherit;">proxy_set_header x-forwarded-proto https;</code>.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">In completely unrelated news, sessions on GoSquared now use secure + httponly cookies!</p><br/>
<p style="font-weight: inherit; font-style: inherit;">PS. remember to add <code style="font-weight: inherit; font-style: inherit;">proxy_set_header Host $host;</code> too if you need the host header to be forwarded too, it appears to get lost otherwise.</p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<br/>
<header style="color: #000000;"><br/>
<h1 class="entry-title" style="font-weight: 500; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit; color: #1f4561;" title="How we made the GoSquared site 4x faster" href="https://engineering.gosquared.com/gosquared-static-website" rel="bookmark">How we made the GoSquared site 4x faster</a></h1><br/>
<h2 class="the_subtitle" style="font-weight: 200; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit; color: #1f4561;" href="https://engineering.gosquared.com/gosquared-static-website">Fast analytics needs a fast marketing site</a></h2><br/>
</header><section class="entry-content"><br/>
<p style="font-weight: inherit; font-style: inherit;"><img loading="lazy" lazyload="on"  style="font-weight: inherit; font-style: inherit;" src="https://static.gosquared.com/images/liquidicity/13_10_22_staticsite_01.png" alt="Making the GoSquared site 4x faster – the new static website" /></p><br/>
<p style="font-weight: inherit; font-style: inherit;">It's a well known fact that a static website will usually be faster than having everything running through a server-side language, like PHP or Ruby. Until a few weeks ago, the majority of the GoSquared site was still being generated by PHP code. Some of this code was <a style="font-weight: inherit; font-style: inherit;" title="GoSquared is 7 years old" href="https://www.gosquared.com/blog/start-up-story" target="_blank">as old as GoSquared itself</a> and most of it had become obsolete, unnecessarily slowing down the site.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">We recently replaced all this with a brand new static site.</p><br/>
<br/>
<h2 style="font-style: inherit; color: #333332;">Why?</h2><br/>
<p style="font-weight: inherit; font-style: inherit;">Building your website using PHP encourages you to put a lot of logic and functionality within an HTML page, rather than thinking through exactly why that functionality is needed and how to implement it properly.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">We're also huge <a style="font-weight: inherit; font-style: inherit;" title="Node - GoSquared loves Node" href="http://nodejs.org/" target="_blank">Node.js</a> fans at GoSquared, and we wanted to have all of the account logic and administration in a Node.js application, which you'll be able to read more about in future posts.</p><br/>
<br/>
<h3 style="font-style: inherit; color: #333332;">Maintainability</h3><br/>
<p style="font-weight: inherit; font-style: inherit;">In HTML, CSS and JavaScript, we follow the concept of <code style="font-weight: inherit; font-style: inherit;">Separation of Concerns</code> (keep all files separate and detached) to improve the maintainability of code – there shouldn't be any inline CSS in your HTML. But we did have a huge amount of inline PHP, which is potentially even worse than any of the others.</p><br/>
<br/>
<h3 style="font-style: inherit; color: #333332;">Speed</h3><br/>
<p style="font-weight: inherit; font-style: inherit;">Static HTML files are a lot faster than dynamic pages. Since release, we've seen a very noticeable decrease in page load times. We were also able to minify and compress all of the assets that make up those pages. View the source if you want to see – HTML is <strong style="font-style: inherit;">20% smaller</strong>, <strong style="font-style: inherit;">CSS 17% smaller</strong> and <strong style="font-style: inherit;">JavaScript a massive 40% smaller</strong>. This has a huge impact, especially for our mobile users.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">PHP can also be slow, and we knew we could speed things up by writing all admin functions in Node.js and making as much as possible asynchronous and parallel, while removing all PHP from the pages so there will be no server processing before page load.</p><br/>
<br/>
<h3 style="font-style: inherit; color: #333332;">Uptime, costs and scalability</h3><br/>
<p style="font-weight: inherit; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit;" title="Amazon S3 in use at GoSquared" href="http://aws.amazon.com/s3/" target="_blank">S3</a> has an availability of ~99.99% and can handle any amount of traffic, so unless we make a serious mistake, the site should never go down due to high traffic. Having a few static files on S3 is a lot cheaper than running a small cluster of PHP servers, and much easier to manage.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">We do still route all traffic through our <a style="font-weight: inherit; font-style: inherit;" title="Nginx in use at GoSquared" href="http://nginx.com/" target="_blank">nginx</a> cluster, but that scales incredibly well. See <a style="font-weight: inherit; font-style: inherit;" href="https://engineering.gosquared.com/optimising-nginx-node-js-and-networking-for-heavy-workloads" target="_blank">our post on scaling nginx with Node.js</a>.</p><br/>
<br/>
<h2 style="font-style: inherit; color: #333332;">How?</h2><br/>
<h3 style="font-style: inherit; color: #333332;">Serenity</h3><br/>
<p style="font-weight: inherit; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit;" href="http://simontabor.com/labs/serenity" target="_blank">Serenity</a> is a static site generation framework written in Node.js (<a style="font-weight: inherit; font-style: inherit;" href="https://github.com/simontabor/serenity" target="_blank">open source</a> and available on <a style="font-weight: inherit; font-style: inherit;" href="https://npmjs.org/package/serenity" target="_blank">NPM</a>). I wrote Serenity as there was a lack of tools for developers who like to use EJS and JSON (rather than liquid and YAML). It's basically Jekyll for JavaScripters.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">It allows easy asset management, compression and is optimised for CDNs by providing asset path helpers which add a hash to the asset name so long cache TTLs can be used.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">PHP <code style="font-weight: inherit; font-style: inherit;">include footer.php</code> was replaced with <code style="font-weight: inherit; font-style: inherit;">&lt;% include footer %&gt;</code> and there were the additional added benefits of layouts, templates, inline assets and much more.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">We used layouts and includes extensively to provide a consistent site look and feel across all of the pages. One update to the signup form include will update every form on the entire site and regenerate the HTML accordingly.</p><br/>
<br/>
<h3 style="font-style: inherit; color: #333332;">Node.js</h3><br/>
<p style="font-weight: inherit; font-style: inherit;">Node.js is fast, we already know that. It's even faster if the functionality is planned and code is written to play to the strong points.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">Account actions, such as logging in or signing up, are <strong style="font-style: inherit;">4x faster than before</strong>. We were able to utilise the asynchronous nature of Node.js (and keep it tidy by using <code style="font-weight: inherit; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit;" href="https://npmjs.org/package/async" target="_blank">async</a></code>) and therefore were able to fire off multiple concurrent MySQL queries (using <code style="font-weight: inherit; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit;" href="https://npmjs.org/package/mysql" target="_blank">node-mysql</a></code>'s connection pooling). Again, more on this later.</p><br/>
<br/>
<h3 style="font-style: inherit; color: #333332;">AJAX</h3><br/>
<p style="font-weight: inherit; font-style: inherit;">The use of AJAX for logins and signups has made a significant difference too. There's no longer a page reload before being told that you've mistyped your password.</p><br/>
<br/>
<h2 style="font-style: inherit; color: #333332;">Conclusions</h2><br/>
<p style="font-weight: inherit; font-style: inherit;">We've really seen the benefits of converting our public site to be completely static. It's faster, and our users' experience is ultimately more important than the underlying code, so it's a success already. On top of that, we've managed to build a maintainable system which we can update and improve long into the future.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">What are your thoughts? Let us know <a style="font-weight: inherit; font-style: inherit;" title="GoSquared on Twitter" href="https://twitter.com/gosquared" target="_blank">@GoSquared</a> on Twitter.</p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<br/>
<header style="color: #000000;"><br/>
<h1 class="entry-title" style="font-weight: 500; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit; color: #1f4561;" title="Making mobile web apps feel faster" href="https://engineering.gosquared.com/touchstart-events" rel="bookmark">Making mobile web apps feel faster</a></h1><br/>
<h2 class="the_subtitle" style="font-weight: 200; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit; color: #1f4561;" href="https://engineering.gosquared.com/touchstart-events">Using TouchStart events for speed</a></h2><br/>
</header><section class="entry-content"><br/>
<p style="font-weight: inherit; font-style: inherit;"><img loading="lazy" lazyload="on"  style="font-weight: inherit; font-style: inherit;" src="https://static.gosquared.com/images/engineering/13_07_30_touchstart_01.png" alt="The new GoSquared Analytics Dashboard running on iOS on iPhone 5 - responsive design with touchstart events in action" /></p><br/>
<p style="font-weight: inherit; font-style: inherit;">Interacting with mobile web apps often feels sluggish and slow, but our phones are more than capable of handing the applications.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">When you touch a button, you expect it to perform its action immediately. However, a <code style="font-weight: inherit; font-style: inherit;">click</code> event listener will only trigger when the touch finishes (<code style="font-weight: inherit; font-style: inherit;">touchend</code>), rather than when it begins (<code style="font-weight: inherit; font-style: inherit;">touchstart</code>). This delays every action unnecessarily.</p><br/>
<br/>
<h2 style="font-style: inherit; color: #333332;">TouchStart to the rescue</h2><br/>
<p style="font-weight: inherit; font-style: inherit;">The easy solution, then, is to bind all your click events to <code style="font-weight: inherit; font-style: inherit;">touchstart</code> too.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">Oops, we've just made every event trigger twice on touch devices. The solution is also simple, storing a property on the event object to check if it's already been triggered. Luckily, the event object is the same across both triggers, otherwise things would be a lot more difficult.</p><br/>
<br/>
<h2 style="font-style: inherit; color: #333332;">Quick Example</h2><br/>
<h3 style="font-style: inherit; color: #333332;">Old code</h3><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<br/>
<pre>$('.my-button').on('click', function(e) {
    doSomething();
});</pre><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<br/>
<h3 style="font-style: inherit; color: #333332;">New Code</h3><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<br/>
<pre>$('.my-button').on('click touchstart', function(e) {
    if (e.handled) return;

    e.handled = true;
    doSomething();
});</pre><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<br/>
<h2 style="font-style: inherit; color: #333332;">Summary</h2><br/>
<p style="font-weight: inherit; font-style: inherit;">Easy, right? At GoSquared we've made sure we use this solution in as many places as possible, especially our new menubar in GoSquared Beta. <a style="font-weight: inherit; font-style: inherit;" href="https://docs.google.com/forms/d/1W0C_AXiURizZELDG0RJlqAX02NcKUzY8oQp6npc1-Bc/viewform">Apply for early access</a>!</p><br/>
<p style="font-weight: inherit; font-style: inherit;"><small style="font-weight: inherit; font-style: inherit;">Note: don't add the <code style="font-weight: inherit; font-style: inherit;">touchstart</code> listener to very important buttons, such as account settings, as if the user starts scrolling down with their finger over the button, it'll trigger when they don't expect it.</small></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<br/>
<header style="color: #000000;"><br/>
<h1 class="entry-title" style="font-weight: 500; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit; color: #1f4561;" title="Introducing Ribbon" href="https://engineering.gosquared.com/new-node-js-module-ribbon" rel="bookmark">Introducing Ribbon</a></h1><br/>
<h2 class="the_subtitle" style="font-weight: 200; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit; color: #1f4561;" href="https://engineering.gosquared.com/new-node-js-module-ribbon">A lightweight Node.js service wrapper</a></h2><br/>
</header><section class="entry-content"><br/>
<p style="font-weight: inherit; font-style: inherit;">This morning the silence of my room, and subsequently the serenity of my rare hours of sleep were suddenly pierced by my iPhone's ringtone at 5am. On the other end of the line was the mechanised TTS-voice of our server monitoring system, informing me that our DBs had noticed a drop in connections.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">As was my duty, I hopped on to find the source of the issue. It turned out to be faulty reconnection logic in one of many adapters we had developed for managing connections to MySQL servers in our applications. It was a bug that still existed simply because we had too many of these adapters lying around to feasibly maintain, and this one slipped through.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">Over many months, I've noticed that the various clients on offer for connecting to and working with external services, like Redis, MongoDB, RabbitMQ, MySQL etc. all share very similar concepts: a connection is established to a service running on a server, and depending on the state of that connection, you interact with that service using the client.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">However, it's apparent that while sharing similar concepts (such as a connection must be active before querying, and you won't get anywhere with a dead connection), these modules didn't stick to a consistent methodology for your application to understand and respond to changes in state. They'd often use different event names to describe the same states (such as 'connected', 'ready' 'open' to represent an active connection, and 'close', 'end', 'exit', 'error' to denote an inactive connection). Worse still, they commonly lacked convenience methods to check the state, such as .isUp() or .isDown().</p><br/>
<br/>
<h3 style="font-style: inherit; color: #333332;">That's why I wrote <a style="font-weight: inherit; font-style: inherit;" href="https://github.com/TheDeveloper/ribbon" target="_blank">Ribbon</a></h3><br/>
<p style="font-weight: inherit; font-style: inherit;">Predominantly formulated during the small hours of this morning,<a style="font-weight: inherit; font-style: inherit;" href="https://github.com/TheDeveloper/ribbon" target="_blank">Ribbon</a> is simply defined as a lightweight Node.js service wrapper. It provides a standard set of events and methods for use in your applications to react to and verify the status of external services, as an alternative to dealing with various different terminology and definitions for common state events.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">Ribbon instead exposes a set of standard events, such as simply 'up' for connection available, and 'down' for connection unavailable.</p><br/>
<p style="font-weight: inherit; font-style: inherit;"><b style="font-style: inherit;">Adaptors</b><br/>
Ribbon includes a collection of adaptors which inherit the ribbon interface. An adaptor is a controller for your underlying connection or service, known as the client. The adaptor is the interface between the service's client and ribbon.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">Adaptors are bundled as part of Ribbon, and I'd be grateful to anyone contributing adaptors for their use case. I'll be putting together a guide to building an adapter before too long.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">See the <a style="font-weight: inherit; font-style: inherit;" href="https://github.com/TheDeveloper/ribbon" target="_blank">repo</a> for more info + README.</p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<br/>
<article id="post-96" class="post-96 post type-post status-publish format-standard hentry category-node-js tag-application tag-development tag-node-js-2" style="color: #000000;"><header style="font-weight: inherit; font-style: inherit;"><br/>
<h1 class="entry-title" style="font-weight: 500; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit; color: #1f4561;" title="10 Vital Aspects of Building a Node.JS Application" href="https://engineering.gosquared.com/10-vital-aspects-of-building-a-node-js-application" rel="bookmark">10 Vital Aspects of Building a Node.JS Application</a></h1><br/>
<h2 class="the_subtitle" style="font-weight: 200; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit; color: #1f4561;" href="https://engineering.gosquared.com/10-vital-aspects-of-building-a-node-js-application">The 10 commandments of Node</a></h2><br/>
</header><section class="entry-content" style="font-weight: inherit; font-style: inherit;"><br/>
<h2 style="font-style: inherit; color: #333332;">Purpose</h2><br/>
<p style="font-weight: inherit; font-style: inherit;">It sounds antagonisingly obvious, but the same goes for everything you decide to build. Your app needs to have purpose. A job to do. A problem to solve. Solid reasoning here will cement durable foundations for the application itself. It will help you visualise a path towards the solution, as well as maintaining focus on the ultimate goal when you get stuck in and iterate.</p><br/>
<br/>
<h2 style="font-style: inherit; color: #333332;">Structure</h2><br/>
<p style="font-weight: inherit; font-style: inherit;">Structure concerns source code layout, file arrangement, library/module usage and on the whole describes the way the application has been weaved together. Its form will vary greatly depending on the nature of the app you're building. It could be a web application server, which might be an <a style="font-weight: inherit; font-style: inherit;" href="http://expressjs.com/">express</a> app handling static assets, routing, and application logic all in the same app. Or it may be more like a scheduler/worker pipeline, queueing and processing items from a queue. Regardless of the purpose, there are several common patterns that are useful to follow.</p><br/>
<br/>
<ul style="font-weight: inherit; font-style: inherit;"><br/>
	<li style="font-weight: inherit; font-style: inherit;">Modularity. Try to keep your code as DRY (Don't Repeat Yourself) as reasonably possible. If you realise you're going to be needing similar code in many distinct locations or scripts, it's common to drop the function (or 'helper') in a separate file (or module), which may<a style="font-weight: inherit; font-style: inherit;" href="http://nodejs.org/docs/latest/api/modules.html">export</a> a collection of helper functions. The module can then be included via node's <a style="font-weight: inherit; font-style: inherit;" href="http://nodejs.org/api/globals.html#globals_require">require()</a> in all dependant scripts. The aim is to not only avoid rewriting similar functionality multiple times, but also provide an easy way to update the functionality in a single place.</li><br/>
	<li style="font-weight: inherit; font-style: inherit;">Following node conventions, it's common to keep the files for 3rd party node modules in the node_modules/ folder. It's also common to put node_modules in your .gitignore, so that you're not committing irrelevant dependency files.</li><br/>
	<li style="font-weight: inherit; font-style: inherit;">Separate concerns. Assets for frontend (static CSS, javascript, HTML, templates, images, files) should be isolated from backend application logic (routes, server, middleware). Likewise keep deployment scripts, config files, data fixtures and tests separate.</li><br/>
</ul><br/>
<h2 style="font-style: inherit; color: #333332;">Deployment</h2><br/>
<p style="font-weight: inherit; font-style: inherit;">Your method of shipping applications to production can vary greatly depending on the nature of your stack. Here's what we've tried in the past:</p><br/>
<br/>
<ul style="font-weight: inherit; font-style: inherit;"><br/>
	<li style="font-weight: inherit; font-style: inherit;">Manually SSH'ing into servers and cloning the git repository. Pros: full manual control, zero deployment tooling setup. Cons: Completely unfeasible for a large number of servers. Everything must be set up manually, so you don't get any benefits such as upstart / initrc supervisation or logging without work.</li><br/>
	<li style="font-weight: inherit; font-style: inherit;">Capistrano. Pros: Standard procedure for developers on your team. Simple to run: <code style="font-weight: inherit; font-style: inherit;">cap deploy</code>. Cons: Trickier to set up. Introduces Ruby dependency.</li><br/>
	<li style="font-weight: inherit; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit;" href="http://www.opscode.com/chef/">Chef</a> scripts. Pros: Scripted procedures for installing apps. Cons: Need to cook your servers each time you want to deploy. Chef is best used for server installation / config, not app deploys.</li><br/>
	<li style="font-weight: inherit; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit;" href="https://github.com/gerhard/deliver">Deliver</a>. A deploy tool born at GoSquared when we got sick of battling with the other options. It was inspired by <a style="font-weight: inherit; font-style: inherit;" href="http://heroku.com/">Heroku's</a> git-push based deploy system. All you need to do is configure a system user for the application (which you should do anyway – we use chef to automate this), set up a basic deliver config, and then run the <code style="font-weight: inherit; font-style: inherit;">deliver</code>command in your project (after adding it to your $PATH – see deliver setup instructions). It pushes the application to your server(s) using git via SSH, and can use <a style="font-weight: inherit; font-style: inherit;" href="http://ddollar.github.com/foreman/">foreman</a> or equivalent to install upstart supervisation of application booting, respawning and recovery.</li><br/>
</ul><br/>
<p style="font-weight: inherit; font-style: inherit;">This is by no means an exhaustive list of deploy methods, and you may need to be a bit creative to come up with a solution to best fit your needs. Whatever strategy you employ, it's a good idea to include deploy configurations in your application's source control, and to document deploy processes in your README.</p><br/>
<br/>
<h2 style="font-style: inherit; color: #333332;">Configuration</h2><br/>
<p style="font-weight: inherit; font-style: inherit;">Virtually every application has constants and settings that will need to be changed at convenience. The common ones are hostnames, port numbers, timeouts, module options and errors. It's helpful to keep these values in one place, either in a file or in multiple files if there are enough of them. Doing so makes them quicker to change, without having to spend time combing through the code to track them down.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">I used to just dump configuration settings into a file that exported an object of configuration properties. This worked well for a very specific target environment, such as the production environment at the time, but over time it started becoming a maintenance bottleneck that lacked clarity and sprawled into a scribble of conditional statements and multiple files as the infrastructure around the app changed.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">We've since had great results from environment-aware configuration. The idea is you can change configuration values based on the environment in which your application is running. The way this works is simple. You export a shell environment variable called $NODE_ENV contianing an identifier for the environment mode you'll be running the app under. Your application will then tailor the configuration settings using those you've defined specially for that environment when it starts up.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">Environment-aware configuration offers you more leeway throughout the whole application lifecycle. You should be able to develop and run your applications locally, without the need for internet connectivity (you want to be able to hack on trains right? In fact I'm writing this on a train right now ;)). That will require pointing hosts and ports to local services. Then, you'll want to be able to test-drive on a staging server before deploying to production. Each of these will likely require different configurations.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">We commonly use <a style="font-weight: inherit; font-style: inherit;" href="https://npmjs.org/package/config">node-config</a>, a module that's been designed precisely for the job. All you need to do is define your configuration values in config/default.js, and then make a file for each of your various environments, which contain directives that will <em style="font-weight: inherit;">extend</em> the defaults in default.js. You set the $NODE_ENV variable with the environment name, and the module will override the defaults.js with the properties defined in [$NODE_ENV].js. To import the merged configuration object into your app, you simply require() it.</p><br/>
<br/>
<h2 style="font-style: inherit; color: #333332;">Logs, Metrics and Monitoring</h2><br/>
<h4 style="font-style: inherit; color: #333332;">Logs</h4><br/>
<p style="font-weight: inherit; font-style: inherit;">You'll want to give yourself enough evidence to work with should your application misbehave, so you can shoot through from 'b0rked' to 'fixed all of the things' status in as little time as possible. One of the best (and old skool) ways to do this is trusty old logging. General premise is, if you get an error, log the bugger. You should be following node's error handling convention, where the first argument of a callback is reserved for error information should one occur:</p><br/>
<br/>
<pre><code class=" language-javascript" style="font-weight: inherit; font-style: inherit;"><br/>
<span class="token function" style="font-weight: inherit; font-style: inherit;">makeRyanDahlProud<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span><span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">function</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span>err<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> result<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">{</span><br/>
  <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">if</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span>err<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">{</span><br/>
    console<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span><span class="token function" style="font-weight: inherit; font-style: inherit;">log<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span>err<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
  <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">}</span><br/>
<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">}</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span></code></pre><br/>
<p style="font-weight: inherit; font-style: inherit;">How you react to that error, however, is up to you. You may want to log it and carry on. Or you may want to halt execution of that callback. Regardless of your needs, you should have a way of referencing that error in the future, and logging is a simple way to achieve that.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">Although logging errors is good practise, it can potentially lead to a lot of messages being sent to the logs / terminal. The mighty TJ Holowaychuck has developed a module called <a style="font-weight: inherit; font-style: inherit;" href="https://github.com/visionmedia/debug">debug</a> that allows you to namespace log messages so you can later filter a signal from the noise by glob-matching these log message namespaces. TJ has plenty of other handy modules in his <a style="font-weight: inherit; font-style: inherit;" href="https://github.com/visionmedia">repertoire</a>.</p><br/>
<br/>
<h4 style="font-style: inherit; color: #333332;">Metrics</h4><br/>
<p style="font-weight: inherit; font-style: inherit;">Application metrics offer valuable insight into what your application is doing and how often. It serves as a great way to detect unexpected activity, spot bottlenecks and as a point of reference for scaling plans. I put together a simple module called <a style="font-weight: inherit; font-style: inherit;" href="https://github.com/thedeveloper/abacus">abacus</a> which helps you maintain a collection of counters and optionally flush them to <a style="font-weight: inherit; font-style: inherit;" href="http://graphite.wikidot.com/">graphite</a> via <a style="font-weight: inherit; font-style: inherit;" href="https://github.com/etsy/statsd">statsd</a>for plotting visualisations. This has proved exceptionally handy for ensuring the application is behaving within intended operational parameters.</p><br/>
<br/>
<h4 style="font-style: inherit; color: #333332;">Monitoring</h4><br/>
<p style="font-weight: inherit; font-style: inherit;">Not always necessary from the get-go, but it's usually a good idea to keep an eye on resource utilisation information from the server hosting your application. Another early-warning system is useful to have, and it'll help avoid silly reasons for your application to go down. There's nothing more embarrassing than your application breaking because your server ran out of disk space, or you were maxing out the CPU so much it melted.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">There's a huge variety of monitoring tools and services out there:<a style="font-weight: inherit; font-style: inherit;" href="http://ganglia.sourceforge.net/">Ganglia</a>, <a style="font-weight: inherit; font-style: inherit;" href="http://mmonit.com/">Monit</a>, <a style="font-weight: inherit; font-style: inherit;" href="http://www.sonian.com/cloud-monitoring-sensu/">Sensu</a> to name a few open source ones, and<a style="font-weight: inherit; font-style: inherit;" href="http://www.serverdensity.com/">ServerDensity</a>, <a style="font-weight: inherit; font-style: inherit;" href="https://nodetime.com/">NodeTime</a> and <a style="font-weight: inherit; font-style: inherit;" href="http://newrelic.com/">NewRelic</a> as SaaS services.</p><br/>
<br/>
<h2 style="font-style: inherit; color: #333332;">Fault tolerance</h2><br/>
<p style="font-weight: inherit; font-style: inherit;">Tying in closely with deployment considerations, you should think about what'll happen if your application crashes. It's best to have the application under the control of a system supervisor, such as <a style="font-weight: inherit; font-style: inherit;" href="http://upstart.ubuntu.com/">upstart</a> on Ubuntu. Configuring upstart is for the most part trivial, and can handle starting, stopping, and restarting the application if it explodes, so it's worth doing. Foreman has an export facility that generates upstart configs for your foreman-backed application.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">Even if your application will be rebooted if it crashes, what are the implications of it doing so? Will it take your service down for some time? Will it lose data? Will it leave partially-complete work? These are consequences you must architect around, and redundancy is a good way to achieve that. For example, if you're round-robining traffic across a number of servers, consider adding a reverse-proxy intermediary (a load balancer like <a style="font-weight: inherit; font-style: inherit;" href="http://haproxy.1wt.eu/">HAProxy</a> or web server such as <a style="font-weight: inherit; font-style: inherit;" href="http://wiki.nginx.org/Main">nginx</a>) to remove the faulty instance of your app from load balancing until its health checks start passing again.</p><br/>
<br/>
<h2 style="font-style: inherit; color: #333332;">Efficiency &amp; Scaling</h2><br/>
<p style="font-weight: inherit; font-style: inherit;">Rarely an early-stage concern, but as your application matures and handles a high workload, you may need to think about making the app more efficient, or even scaling it. The risk here is premature optimisation. You shouldn't worry about making your app super-scale or super fast early on, because let's face it, before it actually does get high load, why would you bother? Your precious time is much better spent on building the essential featureset, or 'minimally viable' as the lean startups like to call, at least to get it to the stage where you might need to scale.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">When you do hit that stage where a single node with a single instance of your app is not enough, you have several options open to you, all at the mercy of trade-offs which can make it feel like a bit of a minefield. The main priority is to seek out the bottleneck. Why is the application not fast enough? Is it maxing out CPU? Is disk I/O sufficiently large or consistent enough?</p><br/>
<p style="font-weight: inherit; font-style: inherit;">Sometimes the easiest answer is to stick the app on a bigger server with more resources. If this'll work for you, then it'll get the job done quicker than re-architecting the app to work in a multi-node setup, but if you're growing really fast then it's not the most sustainable solution. This method might buy you enough time while you are designing your retaliation, however.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">Scaling the app horizontally across multiple servers is tricky and introduces lots of scope for failure, but carries long-term viability and a fascinating technical challenge.</p><br/>
<br/>
<h2 style="font-style: inherit; color: #333332;">Docs &amp; Team Collaboration</h2><br/>
<p style="font-weight: inherit; font-style: inherit;">An application without documentation is like flat-pack without instructions. You can kind of figure out what it's supposed to do, but doing so is clumsy, time consuming and imprecise. It's much better to provide clear documentation that succinctly complements your code. You're not only going to help others get up and developing quickly, but also salvage your forgetful self when you return to the app in 6 months time to fix an obscure bug.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">I'm not advocating writing essays or tautological assertions that can otherwise be discerned from the code. There's a lot that code can explain itself when it's written clearly and simply. Instead, your documentation should colour in the grey areas that the code cannot clearly convey. Comments should help explain trickier portions of functionality, as well as inform about design decisions, trade-offs, dependencies, pitfalls, edge-cases and other considerations made. As an application matures, the documentation:code ratio should increase, to reflect its journey towards stability from transience. There's no point going overboard on the documentation when the app is in its infancy. It will change rapidly in the early stages, and you'll sink a load of time into documentation that becomes obsolete in a short time.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">Every application should include a README[.md] which contains all the need-to-know essentials of working with the app. Commonly this comprises:</p><br/>
<br/>
<ul style="font-weight: inherit; font-style: inherit;"><br/>
	<li style="font-weight: inherit; font-style: inherit;">A brief description of the app and its purpose</li><br/>
	<li style="font-weight: inherit; font-style: inherit;">Setup instructions</li><br/>
	<li style="font-weight: inherit; font-style: inherit;">Booting instructions</li><br/>
	<li style="font-weight: inherit; font-style: inherit;">Testing instructions</li><br/>
	<li style="font-weight: inherit; font-style: inherit;">Deployment considerations</li><br/>
	<li style="font-weight: inherit; font-style: inherit;">Any other need-to-know pointers</li><br/>
</ul><br/>
<p style="font-weight: inherit; font-style: inherit;">We built a little module that can extract source code comments and generate clean, attractive documentation which reads parallel to the code. It's called <a style="font-weight: inherit; font-style: inherit;" href="https://github.com/jbt/docker">docker</a> and we use it in most of our main apps.</p><br/>
<br/>
<h2 style="font-style: inherit; color: #333332;">Testing</h2><br/>
<p style="font-weight: inherit; font-style: inherit;">When I was starting out, I never realised the importance of testing and never really bothered. Perhaps it's because I'd never been in the situation where, years down the line, your application starts failing and you've no idea how to guarantee which components were working properly and which weren't. Yeah, well, now I've had that experience, it's not pretty. You need tests.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">A rigourous attitude to testing encourages good application design paradigms. You are required to think laterally to compartmentalise components of your app and make it possible to test them individually. This goes beyond basic unit tests which tend to be unnecessarily pedantic, to more informative component and integration tests where you can write probes to ensure your application is consistently fused together properly.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">A good practise is to write tests as you develop your application (once you're more confident that the functionality you're testing is not so much in flux) so that as you progress with the app, you have an ever increasing battery of tests on hand to continuously run. This helps you guarantee you don't break functionality with new developments (regressions). Tests also serve as a great usage example for other developers to understand exactly how various parts of the app are supposed to behave and what the results should be.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">There's a variety of testing frameworks to choose from employing a range of different techniques (<a style="font-weight: inherit; font-style: inherit;" href="http://en.wikipedia.org/wiki/Behavior-driven_development">BDD</a>, <a style="font-weight: inherit; font-style: inherit;" href="http://en.wikipedia.org/wiki/Test-driven_development">TDD</a>). Amongst others, we've tried<a style="font-weight: inherit; font-style: inherit;" href="http://vowsjs.org/">vows</a> and <a style="font-weight: inherit; font-style: inherit;" href="http://en.wikipedia.org/wiki/Test_Anything_Protocol">tap</a> to date but my favourite so far is <a style="font-weight: inherit; font-style: inherit;" href="http://visionmedia.github.com/mocha/">mocha</a> in conjunction with <a style="font-weight: inherit; font-style: inherit;" href="https://github.com/visionmedia/should.js/">should.js</a> which I feel hits the right balance of structure and tooling vs pure javascript, allowing you to use all the same source libraries, script files and boot servers from your tests as you would running the app.</p><br/>
<br/>
<h2 style="font-style: inherit; color: #333332;">Dependencies</h2><br/>
<p style="font-weight: inherit; font-style: inherit;">Node includes a powerful module system and a package manager called "npm" which is designed to help you seamlessly integrate modules into your app. npm endows you with a wealth of open source modules archived in its <a style="font-weight: inherit; font-style: inherit;" href="https://npmjs.org/">index</a> where you're likely to find what you're looking for.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">Once you figure out what components your app might need (such as a client with which you'll communicate with a redis database), it's wise to first check userland node modules in the index for existing implementations. Node.js is one of the hacker's favourites for experimentation, so there's a huge range of modules available for you to try out. Naturally, the quality fluctuates dramatically, and you'll need to build up a sense for what makes a good module and what doesn't (shortlist: README, tests, examples, prestiged author), but generally there's almost always something available for what you require.</p><br/>
<br/>
<div class="entry-links" style="font-weight: inherit; font-style: inherit;"></div><br/>
<div class="entry-links" style="font-weight: inherit; font-style: inherit;"></div><br/>
<div class="entry-links" style="font-weight: inherit; font-style: inherit;"></div><br/>
<div class="entry-links" style="font-weight: inherit; font-style: inherit;"></div><br/>
<div class="entry-links" style="font-weight: inherit; font-style: inherit;"></div><br/>
<div class="entry-links" style="font-weight: inherit; font-style: inherit;"></div><br/>
<div class="entry-links" style="font-weight: inherit; font-style: inherit;"><header style="font-weight: inherit; font-style: inherit;"><br/>
<h1 class="entry-title" style="font-weight: 500; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit; color: #1f4561;" title="Error handling in Node.js" href="https://engineering.gosquared.com/node-js-error-handling-callbacks-vs-promises" rel="bookmark">Error handling in Node.js</a></h1><br/>
<h2 class="the_subtitle" style="font-weight: 200; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit; color: #1f4561;" href="https://engineering.gosquared.com/node-js-error-handling-callbacks-vs-promises">Exploring error handling methods for Node.js apps</a></h2><br/>
</header><section class="entry-content" style="font-weight: inherit; font-style: inherit; color: #3a3f42;">Error handling can be a drag, but it's essential for the stability of your app. Naturally, I'm interested in ways to streamline the error handling process to make it as stable as it can be for the app whilst also being convenient for me to write.<br/>
<br/>
Lately, I've been reading a lot about new features in ES6, such as generators, and that's led me onto promises, an alternative method of asynchronous flow control to callbacks. I decided to look into the differences in how these different methods approach error handling, their strengths and weaknesses.<br/>
<h2 style="color: #333332;">I/O errors: callbacks vs promises</h2><br/>
The main kind of errors we're looking at here are I/O errors in asynchronous operations. These occur when an I/O operation fails to yield the expected results, sometimes due to some external problem outside of your program's control. For example, we might be fetching data from a MySQL database, but our query contains an error:<br/>
<pre><code class=" language-javascript" style="font-weight: inherit; font-style: inherit;"><span class="token comment" style="font-weight: inherit; font-style: inherit; color: #708090;" spellcheck="true"><br/>
// We misspell 'SELECT' in this query so it fails<br/>
</span><span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">var</span> query <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">=</span> <span class="token string" style="font-weight: inherit; font-style: inherit; color: #669900;">'SLECT 1 + 1'</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
con<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span><span class="token function" style="font-weight: inherit; font-style: inherit;">query<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span>query<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">function</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span>err<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">{</span><br/>
 <span class="token comment" style="font-weight: inherit; font-style: inherit; color: #708090;" spellcheck="true"> // query failed. what do we do now?<br/>
</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">}</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
</code></pre><br/>
<h3 style="color: #333332;">Callbacks</h3><br/>
Notice that in this example we are using Node's default style of using a callback to handle the result of the I/O. The first argument of the callback function is <code style="font-weight: inherit; font-style: inherit;">err</code>. This is the standard convention in Node, the one you should follow when writing your own async functions.<br/>
<br/>
<strong style="font-style: inherit;">The first argument to callbacks should always be <code style="font-weight: inherit; font-style: inherit;">err</code></strong><br/>
<br/>
Developers new to Node sometimes forget to follow this convention which makes it very frustrating for other developers trying to work with their code, because they have no consistent point of reference to check whether the operation succeeded or not. But if the first parameter to our callback is reserved for errors then they can be checked before processing the results of each callback.<br/>
<br/>
If <code style="font-weight: inherit; font-style: inherit;">err</code> is falsy (usually null), then the callback can carry on assuming the operation succeeded. Otherwise, it can deal with the error in an appropriate way, such as logging it along with any contextual information. It can then decide whether or not to carry on depending on the severity of the error or whether or not the resultant data is required to continue operation.<br/>
<br/>
Let's implement some error handling for our query error:<br/>
<pre><code class=" language-javascript" style="font-weight: inherit; font-style: inherit;"><br/>
<span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">var</span> log <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">=</span> console<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span>log<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><span class="token comment" style="font-weight: inherit; font-style: inherit; color: #708090;" spellcheck="true"><br/>
// We misspell 'SELECT' in this query so it fails<br/>
</span><span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">var</span> query <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">=</span> <span class="token string" style="font-weight: inherit; font-style: inherit; color: #669900;">'SLECT 1 + 1'</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
con<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span><span class="token function" style="font-weight: inherit; font-style: inherit;">query<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span>query<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">function</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span>err<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">{</span><br/>
  <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">if</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span>err<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span> <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">return</span> <span class="token function" style="font-weight: inherit; font-style: inherit;">log<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span><span class="token string" style="font-weight: inherit; font-style: inherit; color: #669900;">"Query failed. Error: %s. Query: %s"</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> err<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> query<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">}</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
</code></pre><br/>
Here, we check if <code style="font-weight: inherit; font-style: inherit;">err</code> is present. If it is, we log the error and the query that triggered it then return from the function, stopping it from running any further.<br/>
<br/>
<strong style="font-style: inherit;">Parallelism</strong><br/>
<br/>
You might have a collection of multiple async operations executing in parallel. How do we handle errors in any of those?<br/>
<br/>
Our favourite library for asynchronous flow control is <a style="font-weight: inherit; font-style: inherit; color: #3a3f42;" href="https://github.com/caolan/async" target="_blank">async</a>. Both<code style="font-weight: inherit; font-style: inherit;">async.parallel</code> and <code style="font-weight: inherit; font-style: inherit;">async.series</code> accept a collection of operations, and if any of them pass an error to its callback, async will immediately invoke your completion callback with the error:<br/>
<pre><code class=" language-javascript" style="font-weight: inherit; font-style: inherit;"><br/>
<span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">var</span> async <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">=</span> <span class="token function" style="font-weight: inherit; font-style: inherit;">require<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span><span class="token string" style="font-weight: inherit; font-style: inherit; color: #669900;">'async'</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">var</span> log <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">=</span> console<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span>log<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">var</span> op1 <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">=</span> <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">function</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span>cb<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">{</span><br/>
 <span class="token comment" style="font-weight: inherit; font-style: inherit; color: #708090;" spellcheck="true"> // We misspell 'SELECT' in this query so it fails<br/>
</span>  <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">var</span> query <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">=</span> <span class="token string" style="font-weight: inherit; font-style: inherit; color: #669900;">'SLECT 1 + 1'</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
  con<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span><span class="token function" style="font-weight: inherit; font-style: inherit;">query<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span>query<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> cb<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">}</span><br/>
<br/>
<span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">var</span> op2 <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">=</span> <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">function</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span>cb<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">{</span><br/>
 <span class="token comment" style="font-weight: inherit; font-style: inherit; color: #708090;" spellcheck="true"> // This query is fine<br/>
</span>  con<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span><span class="token function" style="font-weight: inherit; font-style: inherit;">query<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span><span class="token string" style="font-weight: inherit; font-style: inherit; color: #669900;">'SELECT 1 + 1'</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> cb<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">}</span><br/>
<br/>
<span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">var</span> ops <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">=</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">[</span>op1<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> op2<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">]</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<br/>
async<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span><span class="token function" style="font-weight: inherit; font-style: inherit;">parallel<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span>ops<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">function</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span>err<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> results<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">{</span><br/>
  <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">if</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span>err<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span> <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">return</span> <span class="token function" style="font-weight: inherit; font-style: inherit;">log<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span><span class="token string" style="font-weight: inherit; font-style: inherit; color: #669900;">"Something went wrong in one of our ops. Err: %s"</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> err<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<br/>
 <span class="token comment" style="font-weight: inherit; font-style: inherit; color: #708090;" spellcheck="true"> // Otherwise, process results<br/>
</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">}</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
</code></pre><br/>
<code style="font-weight: inherit; font-style: inherit;">async.parallel</code> will execute both <code style="font-weight: inherit; font-style: inherit;">op1</code> and <code style="font-weight: inherit; font-style: inherit;">op2</code> in parallel but if either or both fail it will invoke our completion callback with the error that occurred first.<br/>
<br/>
Standard callbacks are all well and good when we're following Node's convention, but it's a little bit laborious to check the result of every operation, and this can quickly get messy when there are many nested callbacks each with their own error handling code.<br/>
<h3 style="color: #333332;">Promises</h3><br/>
Promises are an alternative to callbacks for asynchronous control flow. They are viewed as a solution to the "pyramid of doom" indentation caused by nested callbacks, but they also have some useful error handling features.<br/>
<br/>
<a style="font-weight: inherit; font-style: inherit; color: #3a3f42;" href="https://github.com/kriskowal/q" target="_blank">Q</a> is a popular module to get you working with promises. In its<a style="font-weight: inherit; font-style: inherit; color: #3a3f42;" href="https://github.com/kriskowal/q" target="_blank">README</a>, Q describes the concept of promises:<br/>
<blockquote style="font-style: italic;"><br/>
<p style="font-weight: inherit; font-style: inherit;">If a function cannot return a value or throw an exception without blocking, it can return a promise instead. A promise is an object that represents the return value or the thrown exception that the function may eventually provide.</p><br/>
</blockquote><br/>
Promises allow us to chain operations together in a sequential manner, without the need for nesting. They also neatly encapsulate any results and errors raised within the chain. For example:<br/>
<pre><code class=" language-javascript" style="font-weight: inherit; font-style: inherit;"><br/>
<span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">var</span> Q <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">=</span> <span class="token function" style="font-weight: inherit; font-style: inherit;">require<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span><span class="token string" style="font-weight: inherit; font-style: inherit; color: #669900;">'Q'</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<br/>
Q<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span><span class="token function" style="font-weight: inherit; font-style: inherit;">fcall<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span>op1<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><br/>
<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span><span class="token function" style="font-weight: inherit; font-style: inherit;">then<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span>op2<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><br/>
<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span><span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">catch</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span><span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">function</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span>err<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">{</span><br/>
 <span class="token comment" style="font-weight: inherit; font-style: inherit; color: #708090;" spellcheck="true"> // An exception was thrown in any of the ops<br/>
</span>  <span class="token function" style="font-weight: inherit; font-style: inherit;">log<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span><span class="token string" style="font-weight: inherit; font-style: inherit; color: #669900;">"Something went wrong"</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">}</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><br/>
<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span><span class="token function" style="font-weight: inherit; font-style: inherit;">done<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<br/>
</code></pre><br/>
Compare this to the callback-based equivalent:<br/>
<pre><code class=" language-javascript" style="font-weight: inherit; font-style: inherit;"><br/>
<br/>
<span class="token function" style="font-weight: inherit; font-style: inherit;">op1<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span><span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">function</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span>err<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">{</span><br/>
  <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">if</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span>err<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">{</span><br/>
    <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">return</span> <span class="token function" style="font-weight: inherit; font-style: inherit;">log<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span><span class="token string" style="font-weight: inherit; font-style: inherit; color: #669900;">'Something went wrong'</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
  <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">}</span><br/>
<br/>
  <span class="token function" style="font-weight: inherit; font-style: inherit;">op2<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span><span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">function</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span>err<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">{</span><br/>
    <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">if</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span>err<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">{</span><br/>
      <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">return</span> <span class="token function" style="font-weight: inherit; font-style: inherit;">log<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span><span class="token string" style="font-weight: inherit; font-style: inherit; color: #669900;">'Something else went wrong'</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
    <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">}</span><br/>
  <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">}</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">}</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<br/>
</code></pre><br/>
<strong style="font-style: inherit;">✔ Clear &amp; compact</strong><br/>
<br/>
The promises method is much more compact, clearer and quicker to write. If an error or exception occurs within any of the ops it is handled by the single <code style="font-weight: inherit; font-style: inherit;">.catch()</code> handler. Having this single place to handle all errors means you don't need to write error checking for each stage of the work.<br/>
<br/>
<strong style="font-style: inherit;">✔ Exception handling</strong><br/>
<br/>
Additionally, the promise chain has more robust protection against exceptions and runtime errors that could be thrown within operations. If an exception is thrown, it will be caught by your <code style="font-weight: inherit; font-style: inherit;">.catch()</code> handler, or any intermediary error handlers passed to each <code style="font-weight: inherit; font-style: inherit;">.then</code> step. In contrast, the callback method would crash the node process because it doesn't encapsulate exceptions thrown in I/O callbacks. Catching exceptions like this allows you to gracefully handle the error in an appropriate way instead of crashing the process straight away.<br/>
<br/>
<strong style="font-style: inherit;">✔ Better stack traces</strong><br/>
<br/>
Furthermore, you can use Q's <a style="font-weight: inherit; font-style: inherit; color: #3a3f42;" href="https://github.com/kriskowal/q#long-stack-traces" target="_blank">long stack support</a> to get more helpful stack traces that keep track of the call stack across asynchronous operations.<br/>
<br/>
<strong style="font-style: inherit;">✘ Compatibility</strong><br/>
<br/>
One slight disadvantage of promises is that in order to use them, you need to make any normal node callback-style code compatible with promise flow control. This usually involves passing the functions through an adapter to make it compatible with promises, such as Q's<code style="font-weight: inherit; font-style: inherit;">Q.denodify(fn)</code>.<br/>
<h2 style="color: #333332;">Error events</h2><br/>
We've spoken a lot about I/O errors during asynchronous flow control, but Node.js has another way of running handlers asynchronously: events.<br/>
<br/>
In Node, an object can be made into an event emitter by inheriting the EventEmitter on its prototype. All core node modules that emit events such as <code style="font-weight: inherit; font-style: inherit;">net.Socket</code> or <code style="font-weight: inherit; font-style: inherit;">http.Server</code> inherit from EventEmitter.<br/>
<br/>
<strong style="font-style: inherit;">The special 'error' event</strong><br/>
<br/>
When an event emitter encounters an error (e.g. a TCP socket abruptly disconnects), it will emit a special 'error' event. The 'error' event is special in Node because if there are no listeners on the event emitter for this event then the event emitter will throw an exception and this will crash the process.<br/>
<h3 style="color: #333332;">Handling uncaught exceptions</h3><br/>
You might be tempted to prevent exceptions being thrown by binding a listener to the 'error' event and logging it instead of crashing. This is potentially dangerous, because you usually can't guarantee exactly where the error originated from and what all the consequences of it are. Usually the best thing to do is catch the error, log it, close any existing connections and gracefully restart your app.<br/>
<br/>
<strong style="font-style: inherit;">Do not use <code style="font-weight: inherit; font-style: inherit;">process.on('uncaughtException')</code></strong><br/>
<br/>
<a style="font-weight: inherit; font-style: inherit; color: #3a3f42;" href="http://nodejs.org/api/process.html#process_event_uncaughtexception" target="_blank"><code style="font-weight: inherit; font-style: inherit;">process.on('uncaughtException')</code></a> was added to node for the purpose of catching errors and doing cleanup before the node process exits. Beware! This has quickly become an anti-pattern in Node. It loses the context of the exception, and is prone to hanging if your event handler doesn't call <code style="font-weight: inherit; font-style: inherit;">process.exit()</code>.<br/>
<br/>
<strong style="font-style: inherit;">Domains</strong><br/>
<br/>
<a style="font-weight: inherit; font-style: inherit; color: #3a3f42;" href="http://nodejs.org/api/domain.html" target="_blank">Domains</a> were created as a more official way of capturing uncaught exceptions or stray 'error' events before they get to crash the process.<br/>
<br/>
While the domains API is still in unstable state and is subject to some criticism, it is still better than using <code style="font-weight: inherit; font-style: inherit;">process.on('uncaughtException')</code>.<a style="font-weight: inherit; font-style: inherit; color: #3a3f42;" href="http://nodejs.org/api/domain.html" target="_blank">Read the docs</a> for usage info.<br/>
<h3 style="color: #333332;"><em style="font-weight: inherit;">Further reading on <a style="font-weight: inherit; font-style: inherit; color: #3a3f42;" href="https://github.com/kriskowal/q">Q module</a> and <a style="font-weight: inherit; font-style: inherit; color: #3a3f42;" href="http://nodejs.org/api/domain.html">domains documentation</a>. </em></h3><br/>
<em style="font-weight: inherit;"> </em><br/>
<br/>
&nbsp;<br/>
<br/>
&nbsp;<br/>
<br/>
&nbsp;<br/>
<br/>
&nbsp;<br/>
<br/>
<header style="color: #000000;"><br/>
<h1 class="entry-title" style="font-weight: 500; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit; color: #1f4561;" title="Admin and User Account Systems in Node.js" href="https://engineering.gosquared.com/admin-systems-in-node" rel="bookmark">Admin and User Account Systems in Node.js</a></h1><br/>
<h2 class="the_subtitle" style="font-weight: 200; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit; color: #1f4561;" href="https://engineering.gosquared.com/admin-systems-in-node">Saying goodbye to PHP</a></h2><br/>
<section class="entry-meta" style="font-weight: inherit; font-style: inherit; color: #738089;"><span class="author mugshot" style="font-weight: inherit; font-style: inherit;"><img loading="lazy" lazyload="on"  class="avatar avatar-96 photo" style="font-weight: inherit; font-style: inherit;" src="https://secure.gravatar.com/avatar/69976644e501ce979e9c087a3fe408fa?s=96&amp;d=https%3A%2F%2Fsecure.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D96&amp;r=G" alt="" width="96" height="96" /></span> <span class="author vcard" style="font-weight: inherit; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit; color: #738089;" title="Posts by Simon Tabor" href="https://engineering.gosquared.com/author/simontabor" rel="author">Simon Tabor</a></span> <span class="meta-sep" style="font-weight: inherit; font-style: inherit;">on </span><span class="entry-date" style="font-weight: inherit; font-style: inherit;">March 10, 2014</span></section></header><section class="entry-content"><br/>
<p style="font-weight: inherit; font-style: inherit;"><img loading="lazy" lazyload="on"  style="font-weight: inherit; font-style: inherit;" src="https://static.gosquared.com/images/liquidicity/14_03_10_adminnode_01.png" alt="Admin Systems in Node.js" /></p><br/>
<p style="font-weight: inherit; font-style: inherit;">At GoSquared, we recently migrated our internal admin and user account systems from PHP to Node.js. It brought up some interesting challenges, very different to those that we're usually faced with, like<a style="font-weight: inherit; font-style: inherit;" href="https://engineering.gosquared.com/optimising-nginx-node-js-and-networking-for-heavy-workloads">optimising Node.js for heavy workloads</a>.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">Due to it's asynchronous nature, user management and admin applications aren't usually written in Node.js – but it is possible to build a stable, manageable and flexible system.</p><br/>
<br/>
<h2 style="font-style: inherit; color: #333332;">Classes</h2><br/>
<p style="font-weight: inherit; font-style: inherit;">Using classes is the nicest way to provide an accessible API for your other apps. Everybody will have a <code style="font-weight: inherit; font-style: inherit;">User</code> class, and all classes should inherit from a <code style="font-weight: inherit; font-style: inherit;">Base</code> class which provides common methods, such as<code style="font-weight: inherit; font-style: inherit;">setAttribute</code>, <code style="font-weight: inherit; font-style: inherit;">getAttribute</code>, <code style="font-weight: inherit; font-style: inherit;">insert</code>, <code style="font-weight: inherit; font-style: inherit;">delete</code> – whatever your system requires.</p><br/>
<br/>
<pre><code class=" language-javascript" style="font-weight: inherit; font-style: inherit;"><span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">var</span> util <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">=</span> <span class="token function" style="font-weight: inherit; font-style: inherit;">require<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span><span class="token string" style="font-weight: inherit; font-style: inherit; color: #669900;">'util'</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><span class="token comment" style="font-weight: inherit; font-style: inherit; color: #708090;" spellcheck="true"><br/>
// assume the Base class has common methods already written<br/>
</span><span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">var</span> Base <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">=</span> <span class="token function" style="font-weight: inherit; font-style: inherit;">require<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span><span class="token string" style="font-weight: inherit; font-style: inherit; color: #669900;">'./Base'</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<br/>
<span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">var</span> User <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">=</span> module<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span>exports <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">=</span> <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">function</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span>id<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">{</span><br/>
  <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">var</span> self <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">=</span> this<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
  self<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span>name <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">=</span> <span class="token string" style="font-weight: inherit; font-style: inherit; color: #669900;">'User'</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
  Base<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span><span class="token function" style="font-weight: inherit; font-style: inherit;">apply<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span>this<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> arguments<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
  self<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span>table <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">=</span> <span class="token string" style="font-weight: inherit; font-style: inherit; color: #669900;">'users'</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">}</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<br/>
util<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span><span class="token function" style="font-weight: inherit; font-style: inherit;">inherits<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span>User<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> Base<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<br/>
User<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span>prototype<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span>create <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">=</span> <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">function</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span>details<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> cb<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">{</span><br/>
  <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">var</span> self <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">=</span> this<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<br/>
  self<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span><span class="token function" style="font-weight: inherit; font-style: inherit;">insert<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span>details<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">function</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span>err<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">{</span><br/>
    <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">if</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span>err<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span> <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">return</span> <span class="token function" style="font-weight: inherit; font-style: inherit;">cb<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span>err<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<br/>
   <span class="token comment" style="font-weight: inherit; font-style: inherit; color: #708090;" spellcheck="true"> // other user creation methods, such as subscribing<br/>
</span>   <span class="token comment" style="font-weight: inherit; font-style: inherit; color: #708090;" spellcheck="true"> // to a mailing list etc. etc.<br/>
</span>    <span class="token function" style="font-weight: inherit; font-style: inherit;">cb<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span><span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">null</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
  <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">}</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">}</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
</code></pre><br/>
<p style="font-weight: inherit; font-style: inherit;"><em style="font-weight: inherit;">Note: with ES6 you can use the new classes if you prefer</em></p><br/>
<br/>
<h2 style="font-style: inherit; color: #333332;">Async</h2><br/>
<p style="font-weight: inherit; font-style: inherit;">To avoid getting into callback hell, <a style="font-weight: inherit; font-style: inherit;" href="https://github.com/caolan/async">async</a> is an essential node module. Although async can help avoid issues, some deep callback nesting is unavoidable and should be accepted – so long as larger functions are split into smaller methods. Using smaller methods and then connecting them together with async is easy and can lead to very clean and readable code. A great benefit of writing asynchronous code is that tasks can be done in parallel, making functions significantly faster in places – we were able to get a few over 20x faster after the migration.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">Assuming the methods <code style="font-weight: inherit; font-style: inherit;">getAttributes</code> and <code style="font-weight: inherit; font-style: inherit;">getSubscription</code> already exist…</p><br/>
<br/>
<h3 style="font-style: inherit; color: #333332;">The Wrong Way</h3><br/>
<pre><code class=" language-javascript" style="font-weight: inherit; font-style: inherit;">User<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span>prototype<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span>getDetails <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">=</span> <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">function</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span>cb<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">{</span><br/>
  <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">var</span> self <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">=</span> this<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
  self<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span><span class="token function" style="font-weight: inherit; font-style: inherit;">getAttributes<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">[</span><span class="token string" style="font-weight: inherit; font-style: inherit; color: #669900;">'name'</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> <span class="token string" style="font-weight: inherit; font-style: inherit; color: #669900;">'email'</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">]</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">function</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span>err<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> attributes<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">{</span><br/>
    <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">if</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span>err<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span> <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">return</span> <span class="token function" style="font-weight: inherit; font-style: inherit;">cb<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span>err<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<br/>
    self<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span><span class="token function" style="font-weight: inherit; font-style: inherit;">getSubscription<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span><span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">function</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span>err<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> subscription<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">{</span><br/>
      <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">if</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span>err<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span> <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">return</span> <span class="token function" style="font-weight: inherit; font-style: inherit;">cb<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span>err<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<br/>
      attributes<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span>subscription <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">=</span> subscription<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
      <span class="token function" style="font-weight: inherit; font-style: inherit;">cb<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span><span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">null</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> attributes<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
    <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">}</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
  <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">}</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">}</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
</code></pre><br/>
<h3 style="font-style: inherit; color: #333332;">The Right Way (cleaner and faster)</h3><br/>
<pre><code class=" language-javascript" style="font-weight: inherit; font-style: inherit;">User<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span>prototype<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span>getDetails <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">=</span> <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">function</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span>cb<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">{</span><br/>
  <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">var</span> self <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">=</span> this<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<br/>
  async<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span><span class="token function" style="font-weight: inherit; font-style: inherit;">parallel<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">[</span><br/>
    self<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span>getAttributes<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span><span class="token function" style="font-weight: inherit; font-style: inherit;">bind<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span>self<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">[</span><span class="token string" style="font-weight: inherit; font-style: inherit; color: #669900;">'name'</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> <span class="token string" style="font-weight: inherit; font-style: inherit; color: #669900;">'email'</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">]</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span><br/>
    self<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span>getSubscription<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span><span class="token function" style="font-weight: inherit; font-style: inherit;">bind<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span>self<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><br/>
  <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">]</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">function</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span>err<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> res<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">{</span><br/>
    <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">if</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span>err<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span> <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">return</span> <span class="token function" style="font-weight: inherit; font-style: inherit;">cb<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span>err<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
    <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">var</span> attributes <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">=</span> res<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">[</span><span class="token number" style="font-weight: inherit; font-style: inherit; color: #990055;">0</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">]</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
    attributes<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span>subscription <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">=</span> res<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">[</span><span class="token number" style="font-weight: inherit; font-style: inherit; color: #990055;">1</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">]</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
    <span class="token function" style="font-weight: inherit; font-style: inherit;">cb<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span><span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">null</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> attributes<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
  <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">}</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">}</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
</code></pre><br/>
<h2 style="font-style: inherit; color: #333332;">Cron Jobs</h2><br/>
<p style="font-weight: inherit; font-style: inherit;">Most, if not all, admin systems will require tasks to be run on a regular schedule. We use <a style="font-weight: inherit; font-style: inherit;" href="https://github.com/ncb000gt/node-cron">node-cron</a> to avoid having to maintain crontabs.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">As these systems are designed to be distributed across any number of servers, we use locking (via redis) to ensure the cronjobs are only run once. Larger jobs that, for example, loop over every user, are split into individual <a style="font-weight: inherit; font-style: inherit;" href="https://github.com/simontabor/qp">QP</a> jobs and processed evenly by all servers.</p><br/>
<br/>
<h2 style="font-style: inherit; color: #333332;">Usage by other applications</h2><br/>
<p style="font-weight: inherit; font-style: inherit;">All production applications at GoSquared are written in Node.js, which is great for maintainability. In the past, all admin functions were called via a secure HTTP API which had additional overhead and wasn't terribly flexible – so much so that in places raw MySQL queries were being used rather than the API.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">The solution is to use the admin system as a node module, which exports the classes and and utilities/handlers. This can then be required by any applications and the methods can be called directly – making everything quicker and significantly more versatile. Create an<code style="font-weight: inherit; font-style: inherit;">index.js</code> (or equivalent) file that can export what's needed…</p><br/>
<br/>
<pre><code class=" language-javascript" style="font-weight: inherit; font-style: inherit;"><span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">var</span> fs <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">=</span> <span class="token function" style="font-weight: inherit; font-style: inherit;">require<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span><span class="token string" style="font-weight: inherit; font-style: inherit; color: #669900;">'fs'</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">var</span> Admin <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">=</span> module<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span>exports <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">=</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">{</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">}</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">var</span> classes <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">=</span> fs<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span><span class="token function" style="font-weight: inherit; font-style: inherit;">readdirSync<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span>__dirname <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">+</span> <span class="token string" style="font-weight: inherit; font-style: inherit; color: #669900;">'/src/classes'</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span><span class="token function" style="font-weight: inherit; font-style: inherit;">sort<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<br/>
classes<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span><span class="token function" style="font-weight: inherit; font-style: inherit;">forEach<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span><span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">function</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span>c<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">{</span><br/>
  <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">if</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span>c<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span><span class="token function" style="font-weight: inherit; font-style: inherit;">substr<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span><span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">-</span><span class="token number" style="font-weight: inherit; font-style: inherit; color: #990055;">3</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span> <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">!</span><span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">==</span> <span class="token string" style="font-weight: inherit; font-style: inherit; color: #669900;">'.js'</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span> <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">return</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<br/>
  <span class="token comment" style="font-weight: inherit; font-style: inherit; color: #708090;" spellcheck="true"> // take off JS<br/>
</span>  <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">var</span> name <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">=</span> c<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span><span class="token function" style="font-weight: inherit; font-style: inherit;">slice<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span><span class="token number" style="font-weight: inherit; font-style: inherit; color: #990055;">0</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span><span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">-</span><span class="token number" style="font-weight: inherit; font-style: inherit; color: #990055;">3</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<br/>
 <span class="token comment" style="font-weight: inherit; font-style: inherit; color: #708090;" spellcheck="true"> // don't export the Base class<br/>
</span>  <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">if</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span>name <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">===</span> <span class="token string" style="font-weight: inherit; font-style: inherit; color: #669900;">'Base'</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span> <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">return</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<br/>
 <span class="token comment" style="font-weight: inherit; font-style: inherit; color: #708090;" spellcheck="true"> // define as a getter to improve performance<br/>
</span>  Object<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span><span class="token function" style="font-weight: inherit; font-style: inherit;">defineProperty<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span>Admin<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> name<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">{</span><br/>
    get<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">:</span> <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">function</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">{</span><br/>
      <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">return</span> <span class="token function" style="font-weight: inherit; font-style: inherit;">require<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span>__dirname <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">+</span> <span class="token string" style="font-weight: inherit; font-style: inherit; color: #669900;">'/src/classes/'</span> <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">+</span> name <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">+</span> <span class="token string" style="font-weight: inherit; font-style: inherit; color: #669900;">'.js'</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
    <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">}</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span><br/>
    enumerable<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">:</span> <span class="token boolean" style="font-weight: inherit; font-style: inherit; color: #990055;">true</span><br/>
  <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">}</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">}</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
</code></pre><br/>
<p style="font-weight: inherit; font-style: inherit;">Then, in your applications, it will need to be added as a dependency (use git tags for versioning) and can be used like so…</p><br/>
<br/>
<pre><code class=" language-javascript" style="font-weight: inherit; font-style: inherit;"><span class="token comment" style="font-weight: inherit; font-style: inherit; color: #708090;" spellcheck="true">// pretend we're serving an HTTP request to get a user's details<br/>
</span><span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">var</span> admin <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">=</span> <span class="token function" style="font-weight: inherit; font-style: inherit;">require<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span><span class="token string" style="font-weight: inherit; font-style: inherit; color: #669900;">'admin'</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">var</span> User <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">=</span> admin<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span>User<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<span class="token comment" style="font-weight: inherit; font-style: inherit; color: #708090;" spellcheck="true"><br/>
// app is already defined elsewhere (express)<br/>
</span>app<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span><span class="token function" style="font-weight: inherit; font-style: inherit;">get<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span><span class="token string" style="font-weight: inherit; font-style: inherit; color: #669900;">'/user/:id/details'</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">function</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span>req<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> res<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">{</span><br/>
  <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">var</span> user <span class="token operator" style="font-weight: inherit; font-style: inherit; color: #a67f59;">=</span> <span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">new</span> <span class="token class-name" style="font-weight: inherit; font-style: inherit;">User</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span>req<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span><span class="token function" style="font-weight: inherit; font-style: inherit;">param<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span><span class="token string" style="font-weight: inherit; font-style: inherit; color: #669900;">'id'</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
  user<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span><span class="token function" style="font-weight: inherit; font-style: inherit;">getDetails<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span><span class="token keyword" style="font-weight: inherit; font-style: inherit; color: #0077aa;">function</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span>err<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">,</span> attributes<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span> <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">{</span><br/>
    res<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">.</span><span class="token function" style="font-weight: inherit; font-style: inherit;">json<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">(</span></span>attributes<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
  <span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">}</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
<span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">}</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">)</span><span class="token punctuation" style="font-weight: inherit; font-style: inherit; color: #999999;">;</span><br/>
</code></pre><br/>
<h2 style="font-style: inherit; color: #333332;">Conclusions</h2><br/>
<p style="font-weight: inherit; font-style: inherit;">Although building an admin system in Node.js may not be the obvious choice, it comes with many advantages and has sped up development here at GoSquared. Our applications run faster and are much more flexible, allowing us to optimise them and ultimately provide a better user experience.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">Questions? Comments? Let us know via the usual channels – Twitter (<a style="font-weight: inherit; font-style: inherit;" href="https://twitter.com/gosquared" target="_blank">@GoSquared</a>), <a style="font-weight: inherit; font-style: inherit;" href="https://facebook.com/GoSquared" target="_blank">Facebook</a> or <a style="font-weight: inherit; font-style: inherit;" href="https://gosquared.com/support/emails/new" target="_blank">email</a>.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">Want to work with us and make our user account systems even better? We're hiring a full-stack engineer – <a style="font-weight: inherit; font-style: inherit;" href="https://gosquared.com/support/emails/new" target="_blank">get in touch</a>.</p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<br/>
<header style="color: #000000;"><br/>
<h1 class="entry-title" style="font-weight: 500; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit; color: #1f4561;" title="Infinite DNS queries for free with Route 53" href="https://engineering.gosquared.com/infinite-dns-queries-free-route-53" rel="bookmark">Infinite DNS queries for free with Route 53</a></h1><br/>
<h2 class="the_subtitle" style="font-weight: 200; font-style: inherit;"><a style="font-weight: inherit; font-style: inherit; color: #1f4561;" href="https://engineering.gosquared.com/infinite-dns-queries-free-route-53">Serving billions of requests on a budget</a></h2><br/>
</header><section class="entry-content"><br/>
<p style="font-weight: inherit; font-style: inherit;"><img loading="lazy" lazyload="on"  class="aligncenter" style="font-weight: inherit; font-style: inherit;" src="https://static.gosquared.com/images/liquidicity/14_02_26_route53_01.png" alt="" width="360" height="300" /><br/>
Globally, our service handles billions of requests per month. This amounts to hundreds of millions of queries to our authoritative DNS servers, which are run by AWS' <a style="font-weight: inherit; font-style: inherit;" href="http://aws.amazon.com/route53/" target="_blank">Route 53</a>.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">Some dedicated DNS providers quote upwards of thousands of dollars for this level of DNS traffic.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">How much do all those queries cost us per month? Hundreds? Thousands? More?</p><br/>
<p style="font-weight: inherit; font-style: inherit;">Nope. Under <strong style="font-style: inherit;">$10</strong>.</p><br/>
<br/>
<h2 style="font-style: inherit; color: #333332;">Queries are free with ELB + Route 53</h2><br/>
<p style="font-weight: inherit; font-style: inherit;">That's right. One amazing advantage of Route 53 is that all DNS queries to a record which is mapped to an AWS <a style="font-weight: inherit; font-style: inherit;" href="http://docs.aws.amazon.com/Route53/latest/DeveloperGuide/CreatingAliasRRSets.html" target="_blank">alias</a> are free.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">An AWS alias can be an Elastic Load Balancer (ELB), a CloudFront distribution, an S3 bucket, or another Route 53 record set within the same hosted zone. So effectively you can easily set up your DNS records such that the vast majority of your DNS queries are hitting records mapped to aliases and get all those queries for free.</p><br/>
<p style="font-weight: inherit; font-style: inherit;">Better still, there is no limit!</p><br/>
<p style="font-weight: inherit; font-style: inherit;">Rock on, AWS.</p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;"></p><br/>
<p style="font-weight: inherit; font-style: inherit;">https://www.heroku.com/</p><br/>
<br/>
<nav id="navigation" style="color: #c7c0de;"><br/>
<div class="wrapper"><br/>
<h1 id="logo" style="font-weight: 200; color: #6e5baa;"><a href="https://www.heroku.com/">Heroku</a></h1><br/>
<ul><br/>
	<li><a href="https://www.heroku.com/features">Features</a></li><br/>
	<li><a href="https://www.heroku.com/pricing">Pricing</a></li><br/>
	<li><a href="https://addons.heroku.com/">Add-ons</a></li><br/>
	<li><a href="https://blog.heroku.com/">Blog</a></li><br/>
	<li><a href="https://devcenter.heroku.com/">Documentation</a></li><br/>
	<li><a href="https://help.heroku.com/">Support</a></li><br/>
	<li><a href="https://www.heroku.com/contact">Contact</a></li><br/>
	<li class="user sign-up"><a href="https://id.heroku.com/">Log in</a> <span style="color: #8c7dbb;">or</span> <a class="sign-up highlight" style="color: white;" href="https://id.heroku.com/signup/www-header" data-trackable="{&quot;event&quot;:&quot;clicked&quot;,&quot;target&quot;:&quot;signup&quot;,&quot;page&quot;:&quot;www-header&quot;}">Sign up</a></li><br/>
</ul><br/>
</div><br/>
</nav><section id="hero" class="center full-viewport" style="color: #c7c0de;"><br/>
<div class="wrapper center"><br/>
<div class="content"><hgroup><br/>
<h1 style="font-weight: 200; color: white;">Build, run, and scale apps.</h1><br/>
<h2 style="font-weight: 400; color: inherit;">Cloud computing designed and built for developers.</h2><br/>
</hgroup><br/>
<div class="mod-signup"><a class="button" style="font-weight: bold; color: #58488a;" href="https://id.heroku.com/signup/www-home-top" data-trackable="{&quot;event&quot;:&quot;clicked&quot;,&quot;target&quot;:&quot;signup&quot;,&quot;page&quot;:&quot;www-home-top&quot;}">Sign up for free</a><small>No credit card required</small></div><br/>
</div><br/>
</div><br/>
</section></section></section></section></div><br/>
</section></article></section></section></section></section></section></section></div>
  <br/>
  <br/>
  <br/>
  <footer>
    <center><a rel="first" title="First Article" itemprop="relatedLink" href="https://icompile.eladkarako.com/show-hidden-devices-in-windows-device-manager">&vert;&lt;</a>&nbsp;<a rel="previous" title="Previous Article" itemprop="relatedLink" href="https://icompile.eladkarako.com/disconnect-a-windows-based-virtual-machine-without-logging-off">&lt;</a>&nbsp;<a rel="index" title="Home-Page" itemprop="relatedLink" href="https://icompile.eladkarako.com/">&Hat;</a>&nbsp;<a rel="next" title="Next Article" itemprop="relatedLink" href="https://icompile.eladkarako.com/c-cryptography-code-segments-i-use-a-lot-lately">&gt;</a>&nbsp;<a rel="last" title="Last Article" itemprop="relatedLink" href="https://icompile.eladkarako.com/shealth">&gt;&vert;</a></center>
    <br/>
    <table>
      <thead>
        <tr><td colspan="2">Next Articles</td></tr>
      </thead>
      <tbody>
        <tr><td><a itemprop="relatedLink" href="https://icompile.eladkarako.com/c-cryptography-code-segments-i-use-a-lot-lately">C++ Cryptography Code-Segments I Use A Lot Lately</a></td><td><a itemprop="relatedLink" href="https://icompile.eladkarako.com/poem-about-an-ad-for-a-generic-brand">Poem about an Ad for a Generic Brand</a></td></tr>
        <tr><td><a itemprop="relatedLink" href="https://icompile.eladkarako.com/independence-day-2014">Independence Day 2014</a></td><td><a itemprop="relatedLink" href="https://icompile.eladkarako.com/a-new-best-reading-blog-about-security-of-web-servers-using-htaccess">A New Best Reading Blog About Security Of Web-Servers Using htaccess :)</a></td></tr>
        <tr><td><a itemprop="relatedLink" href="https://icompile.eladkarako.com/blocking-access-by-ip">Blocking ACCESS By IP</a></td><td><a itemprop="relatedLink" href="https://icompile.eladkarako.com/javascript-code-segment-efficient-cross-broser-alternative-to-hasattribute">JavaScript Code-Segment: efficient cross-broser alternative to 'hasAttribute'</a></td></tr>
        <tr><td><a itemprop="relatedLink" href="https://icompile.eladkarako.com/javascript-code-segment-efficient-cross-broser-foreach-protype-for-array">JavaScript Code-Segment: efficient cross-broser forEach protype for Array</a></td><td><a itemprop="relatedLink" href="https://icompile.eladkarako.com/javascript-code-segment-efficient-cross-broser-foreach-protype-override-for-both-array-and-object-can-be-used-for-jsons">JavaScript Code-Segment: efficient cross-broser forEach protype override for both array and object (can be used for JSONs)</a></td></tr>
        <tr><td><a itemprop="relatedLink" href="https://icompile.eladkarako.com/php-non-english-hebrew-file-names-file-system-processing-for-jquery-mobile-html5-application-rendering">For jQuery Mobile HTML5 Application Rendering</a></td><td><a itemprop="relatedLink" href="https://icompile.eladkarako.com/favorite-bo-burnham-poems">Favorite Bo Burnham Poems</a></td></tr>
        <tr><td><a itemprop="relatedLink" href="https://icompile.eladkarako.com/tcl-irule-to-networks-targeted-with-dynamic-ip">TCL iRule to Networks-Targeted With Dynamic IP</a></td><td><a itemprop="relatedLink" href="https://icompile.eladkarako.com/javascript-snippet-avoid-loops-gather-data-using-map">Gather Data Using MAP</a></td></tr>
        <tr><td><a itemprop="relatedLink" href="https://icompile.eladkarako.com/html5-security-cheatsheet">HTML5 Security Cheatsheet - What your browser does when you look away...</a></td><td><a itemprop="relatedLink" href="https://icompile.eladkarako.com/cosmos-a-space-time-odyssey-is-sooooo-boring">Cosmos: A Space-Time Odyssey is sooooo boring!!</a></td></tr>
        <tr><td><a itemprop="relatedLink" href="https://icompile.eladkarako.com/javascript-package-manager-for-the-web-bower">JavaScript Package Manager For The web - Bower</a></td><td><a itemprop="relatedLink" href="https://icompile.eladkarako.com/hosts-eladkarako-com-block-ads-and-malware-hosts-from-accessing-your-pc-and-mobile-devices">hosts.eladkarako.com - Block Ads and Malware Hosts From Accessing Your PC and Rooted Mobile Devices</a></td></tr>
      </tbody>
    </table>
  </footer>
</article>
<br/>
<hr/>
<br/>


<br/>
<script defer="defer"        crossorigin="anonymous"  type="text/javascript"        charset="UTF-8" loading="eager" lazyload="off"        src="https://icompile.eladkarako.com/_resources/index.js"></script>
</body>
</html>